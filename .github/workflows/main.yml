name: ğŸ“¡ IRAN NOW - Ultimate Manual Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 1', required: true }
      url2: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 2', required: true }
      url3: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 3', required: true }
      url4: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 4', required: true }
      url5: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 5', required: true }
      bottom_text: { description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ·', required: false, default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± 24/7' }
      stream_duration: { description: 'Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ØªØ«Ø¨ÙŠØª FFmpeg Ùˆ yt-dlp ÙˆÙ…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip
        # ØªØ«Ø¨ÙŠØª yt-dlp Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© (Impersonate) Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ù…Ø§ÙŠØ©
        pip3 install -U "yt-dlp[build-in]" gdown

    - name: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª
      id: timing
      run: |
        gdown --id 1mcqB-MvngWziGqNPuRs9gO39XtdbddgJ -O background.png || ffmpeg -f lavfi -i color=c=black:s=1920x1080 -frames:v 1 background.png
        echo "end_time=$(($(date +%s) + (${{ github.event.inputs.stream_duration }} * 3600)))" >> $GITHUB_OUTPUT

    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      run: |
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ ÙˆÙ‡Ù…ÙŠ Ù„ØªØ¬Ø§ÙˆØ² Ø­Ù…Ø§ÙŠØ© Cloudflare Ùˆ Dailymotion
        EXTRACT="yt-dlp --quiet --no-warnings --get-url --impersonate chrome"
        
        V1=$($EXTRACT "${{ github.event.inputs.url1 }}")
        V2=$($EXTRACT "${{ github.event.inputs.url2 }}")
        V3=$($EXTRACT "${{ github.event.inputs.url3 }}")
        V4=$($EXTRACT "${{ github.event.inputs.url4 }}")
        V5=$($EXTRACT "${{ github.event.inputs.url5 }}")

        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¯Ù‚Ø© 4K Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±
        FILTER="[1:v]scale=960:540,setsar=1[v1]; [2:v]scale=960:540,setsar=1[v2]; \
                [3:v]scale=640:540,setsar=1[v3]; [4:v]scale=640:540,setsar=1[v4]; \
                [5:v]scale=640:540,setsar=1[v5]; [0:v]scale=1920:1080[bg]; \
                [bg][v1]overlay=0:0[b1]; [b1][v2]overlay=960:0[b2]; \
                [b2][v3]overlay=0:540[b3]; [b3][v4]overlay=640:540[b4]; \
                [b4][v5]overlay=1280:540[b5]; \
                [b5]drawtext=text='${{ github.event.inputs.bottom_text }}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=60:x=w-mod(150*t\,w+tw):y=h-80:box=1:boxcolor=black@0.6[out]"

        while [ $(date +%s) -lt ${{ steps.timing.outputs.end_time }} ]; do
          ffmpeg -re -stream_loop -1 -i background.png \
            -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -i "$V1" -i "$V2" -i "$V3" -i "$V4" -i "$V5" \
            -filter_complex "$FILTER" -map "[out]" -map 1:a \
            -c:v libx264 -preset ultrafast -tune zerolatency -b:v 3000k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -ar 44100 \
            -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY" || sleep 10
        done
