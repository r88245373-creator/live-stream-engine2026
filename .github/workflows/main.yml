name: Render Pro Live Dashboard Cloud

on:
  workflow_dispatch:
    inputs:
      green_zone_link:
        description: 'Link for Top Left (Green)'
        required: true
      red_zone_link:
        description: 'Link for Top Right (Red)'
        required: true
      yellow_zone_link:
        description: 'Link for Middle Left (Yellow)'
        required: true
      blue_zone_link:
        description: 'Link for Middle Center (Blue)'
        required: true
      grey_zone_link:
        description: 'Link for Middle Right (Grey)'
        required: true
      bottom_text:
        description: 'Arabic Text for Black Zone'
        required: true
        default: 'عاجل - تغطية حصرية مباشرة لمستجدات الأحداث الإقليمية والدولية'

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # تثبيت الخطوط العربية لضمان ظهور النص بشكل صحيح
          sudo apt-get install -y ffmpeg fonts-vlgothic python3-pip fonts-noto-cjk
          # تثبيت وتحديث yt-dlp
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      - name: Download Background from Google Drive
        run: |
          FILE_ID="1mcqB-MvngWziGqNPuRs9gO39XtdbddgJ"
          curl -L "https://docs.google.com/uc?export=download&id=${FILE_ID}" -o background.png

      - name: Extract Live Links (with Impersonation & Fallback)
        run: |
          # محاولة استخراج الروابط مع التخفي لتجاوز حماية المواقع
          # في حال فشل الرابط، سيتم وضع رابط فيديو "اختبار" لضمان عدم توقف المشروع
          yt-dlp --extractor-args "generic:impersonate" -g -f b "${{ github.event.inputs.green_zone_link }}" > L1.txt || echo "https://raw.githubusercontent.com/intel-iot-devkit/sample-videos/master/person-bicycle-car-detection.mp4" > L1.txt
          yt-dlp --extractor-args "generic:impersonate" -g -f b "${{ github.event.inputs.red_zone_link }}" > L2.txt || echo "https://raw.githubusercontent.com/intel-iot-devkit/sample-videos/master/person-bicycle-car-detection.mp4" > L2.txt
          yt-dlp --extractor-args "generic:impersonate" -g -f b "${{ github.event.inputs.yellow_zone_link }}" > L3.txt || echo "https://raw.githubusercontent.com/intel-iot-devkit/sample-videos/master/person-bicycle-car-detection.mp4" > L3.txt
          yt-dlp --extractor-args "generic:impersonate" -g -f b "${{ github.event.inputs.blue_zone_link }}" > L4.txt || echo "https://raw.githubusercontent.com/intel-iot-devkit/sample-videos/master/person-bicycle-car-detection.mp4" > L4.txt
          yt-dlp --extractor-args "generic:impersonate" -g -f b "${{ github.event.inputs.grey_zone_link }}" > L5.txt || echo "https://raw.githubusercontent.com/intel-iot-devkit/sample-videos/master/person-bicycle-car-detection.mp4" > L5.txt

      - name: Render Professional Dashboard
        run: |
          URL1=$(cat L1.txt)
          URL2=$(cat L2.txt)
          URL3=$(cat L3.txt)
          URL4=$(cat L4.txt)
          URL5=$(cat L5.txt)
          
          ffmpeg -i background.png \
          -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 -i "$URL1" \
          -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 -i "$URL2" \
          -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 -i "$URL3" \
          -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 -i "$URL4" \
          -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 -i "$URL5" \
          -filter_complex \
          "[1:v]scale=1920:1000:force_original_aspect_ratio=decrease,pad=1920:1000:(ow-iw)/2:(oh-ih)/2[green]; \
           [2:v]scale=1920:1000:force_original_aspect_ratio=decrease,pad=1920:1000:(ow-iw)/2:(oh-ih)/2[red]; \
           [3:v]scale=1520:940:force_original_aspect_ratio=decrease,pad=1520:940:(ow-iw)/2:(oh-ih)/2[yellow]; \
           [4:v]scale=1540:940:force_original_aspect_ratio=decrease,pad=1540:940:(ow-iw)/2:(oh-ih)/2[blue]; \
           [5:v]scale=780:940:force_original_aspect_ratio=decrease,pad=780:940:(ow-iw)/2:(oh-ih)/2[grey]; \
           [0:v][green]overlay=x=0:y=0[b1]; \
           [b1][red]overlay=x=1920:y=0[b2]; \
           [b2][yellow]overlay=x=0:y=1000[b3]; \
           [b3][blue]overlay=x=1520:y=1000[b4]; \
           [b4][grey]overlay=x=3060:y=1000[b5]; \
           [b5]drawtext=text='${{ github.event.inputs.bottom_text }}':fontcolor=white:fontsize=110:borderw=4:bordercolor=red:y=2050+((2160-2050-th)/2):x=-tw+mod(t*220\,w+tw)[out]" \
          -map "[out]" -c:v libx264 -preset ultrafast -t 30 -y final_dashboard_cloud.mp4

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Cloud-Dashboard-Result
          path: final_dashboard_cloud.mp4
