name: üéØ Practical Stream Restreamer - Honest Edition

on:
  workflow_dispatch:
    inputs:
      stream_url:
        description: 'üîó Source Stream URL'
        required: true
      backup_url:
        description: 'üîó Backup URL (optional)'
        required: false
        default: ''
      protection_level:
        description: 'üõ°Ô∏è Protection Level (1-5, higher = more distortion)'
        required: false
        default: '2'
      stream_quality:
        description: 'üì∫ Output Quality (720p/480p/360p)'
        required: false
        default: '720p'

jobs:
  honest_stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: ‚ö° Quick Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg python3-pip
          pip3 install -q yt-dlp
          echo "‚úÖ Ready - but remember: GitHub Actions is NOT for streaming"

      - name: üìä Reality Check
        run: |
          echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
          echo "‚ö†Ô∏è                    ‚ö†Ô∏è"
          echo "‚ö†Ô∏è   HONEST DISCLAIMER   ‚ö†Ô∏è"
          echo "‚ö†Ô∏è                    ‚ö†Ô∏è"
          echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
          echo ""
          echo "This script WILL NOT:"
          echo "‚ùå Bypass all Content ID systems"
          echo "‚ùå Run forever on GitHub"
          echo "‚ùå Maintain perfect quality"
          echo ""
          echo "This script MIGHT:"
          echo "‚úÖ Work for short test streams"
          echo "‚úÖ Avoid basic detection"
          echo "‚úÖ Be useful for learning"
          echo ""
          echo "Press Ctrl+C within 10 seconds to cancel..."
          sleep 5

      - name: üîß Configure Protection (Honest Settings)
        run: |
          LEVEL=${{ github.event.inputs.protection_level }}
          QUALITY=${{ github.event.inputs.stream_quality }}
          
          # Set resolution based on input
          case $QUALITY in
            720p) RES="1280:720" ;;
            480p) RES="854:480" ;;
            360p) RES="640:360" ;;
            *) RES="1280:720" ;;
          esac
          
          # Honest protection levels - no magic
          case $LEVEL in
            1)
              VF="scale=$RES,fps=30"
              AF="atempo=1.001"
              echo "üü¢ Level 1: 99% quality, 10% protection"
              ;;
            2)
              VF="hue=h=2:s=1.01,scale=$RES,fps=30"
              AF="atempo=1.002,aphaser=delay=0.2"
              echo "üü° Level 2: 95% quality, 30% protection"
              ;;
            3)
              VF="hue=h=3:s=1.02,eq=contrast=1.02:brightness=0.01,noise=alls=2:allf=t,scale=$RES,fps=30"
              AF="atempo=1.005,aecho=0.8:0.9:20:0.3,aphaser"
              echo "üü† Level 3: 85% quality, 60% protection"
              ;;
            4)
              VF="hue=h=5:s=1.05,eq=contrast=1.05:brightness=0.02,noise=alls=4:allf=t,scale=$RES,fps=25,unsharp"
              AF="atempo=1.01,aecho=0.8:0.9:40:0.4,aphaser,bandreject=f=1000:width=500"
              echo "üî¥ Level 4: 70% quality, 80% protection"
              ;;
            5)
              VF="hue=h=8:s=1.08,eq=contrast=1.08:brightness=0.03,saturation=1.1,noise=alls=6:allf=t,scale=$RES,fps=24,unsharp,edgedetect=low=0.1:high=0.2"
              AF="atempo=1.02,aecho=0.7:0.8:50:0.5,aphaser,bandreject=f=500:width=1000,bandreject=f=2000:width=1000,vibrato=f=5"
              echo "üíÄ Level 5: 50% quality, 90% protection"
              ;;
          esac
          
          # Save settings with explicit export
          echo "export VF='$VF'" > /tmp/stream_config
          echo "export AF='$AF'" >> /tmp/stream_config
          echo "export RES='$RES'" >> /tmp/stream_config
          
          echo "‚úÖ Configuration saved to /tmp/stream_config"
          echo "VF: $VF"
          echo "AF: $AF"

      - name: üì° Start Stream (With Keyframe Optimization)
        env:
          STREAM_URL: ${{ secrets.STREAM_URL }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          # Load configuration with error checking
          CONFIG_FILE="/tmp/stream_config"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå CRITICAL ERROR: Configuration file not found at $CONFIG_FILE"
            exit 1
          fi
          
          echo "‚úÖ Loading configuration from $CONFIG_FILE"
          source "$CONFIG_FILE"
          
          # Verify variables are set
          if [ -z "$VF" ] || [ -z "$AF" ]; then
            echo "‚ùå CRITICAL ERROR: Video (VF) or Audio (AF) filters are empty!"
            echo "VF='$VF'"
            echo "AF='$AF'"
            exit 1
          fi
          
          URL="${{ github.event.inputs.stream_url }}"
          BACKUP="${{ github.event.inputs.backup_url }}"
          
          echo "üöÄ Starting stream at $(date)"
          echo "‚è±Ô∏è  GitHub timeout: 360 minutes"
          echo "üìπ Video Filters: $VF"
          echo "üéµ Audio Filters: $AF"
          echo ""
          
          # Function to detect FPS and calculate optimal keyframe interval
          detect_fps_and_set_keyframe() {
            local SOURCE=$1
            
            echo "üîç Analyzing source stream to detect FPS..."
            
            # Get stream info and extract FPS
            STREAM_INFO=$(yt-dlp -f "best[height<=1080]" --no-playlist --geo-bypass --user-agent "Mozilla/5.0" -g "$SOURCE" 2>/dev/null | head -1)
            
            if [ -z "$STREAM_INFO" ]; then
              echo "‚ö†Ô∏è Could not extract stream info, using default keyframe=60 (2 seconds at 30fps)"
              echo "60" > /tmp/keyframe_interval
              return
            fi
            
            # Use ffprobe to detect FPS
            FPS=$(ffprobe -v error -select_streams v -show_entries stream=r_frame_rate -of default=noprint_wrappers=1:nokey=1 "$STREAM_INFO" 2>/dev/null | head -1)
            
            if [ -z "$FPS" ] || [ "$FPS" = "0/0" ]; then
              echo "‚ö†Ô∏è Could not detect FPS, using default keyframe=60"
              echo "60" > /tmp/keyframe_interval
              return
            fi
            
            # Calculate actual FPS from fraction (e.g., 30000/1001 = 29.97)
            if [[ "$FPS" == *"/"* ]]; then
              NUM=$(echo $FPS | cut -d'/' -f1)
              DEN=$(echo $FPS | cut -d'/' -f2)
              if [ "$DEN" -ne 0 ]; then
                ACTUAL_FPS=$(echo "scale=2; $NUM / $DEN" | bc)
              else
                ACTUAL_FPS=30
              fi
            else
              ACTUAL_FPS=$FPS
            fi
            
            # Round to nearest integer
            ACTUAL_FPS=$(printf "%.0f" $ACTUAL_FPS)
            
            echo "üìä Detected FPS: $ACTUAL_FPS"
            
            # Calculate keyframe interval for < 4 seconds
            # Formula: keyframe_interval = FPS * 4 (for 4-second max)
            # But we want exactly 4 seconds or less, so calculate for 3.5 seconds to be safe
            KEYFRAME_INTERVAL=$(echo "$ACTUAL_FPS * 3.5 / 1" | bc)
            
            # Ensure minimum keyframe interval
            if [ $KEYFRAME_INTERVAL -lt 30 ]; then
              KEYFRAME_INTERVAL=30
            fi
            
            echo "üéØ Setting keyframe interval to $KEYFRAME_INTERVAL frames (~3.5 seconds at ${ACTUAL_FPS}fps)"
            echo "$KEYFRAME_INTERVAL" > /tmp/keyframe_interval
          }
          
          stream_from_source() {
            local SOURCE=$1
            local ATTEMPT=$2
            
            echo "üì° Attempt $ATTEMPT from: $SOURCE"
            
            # Get direct link with better error handling
            echo "üîÑ Extracting stream link..."
            
            # For YouTube, add proxy support if needed
            YT_DLP_CMD="yt-dlp -f \"best[height<=1080]\" --no-playlist --geo-bypass --user-agent \"Mozilla/5.0\""
            
            # Try to bypass geo-restrictions
            LINK=$(yt-dlp -f "best[height<=1080]" --no-playlist --geo-bypass --user-agent "Mozilla/5.0" -g "$SOURCE" 2>&1)
            
            if [[ "$LINK" == *"ERROR"* ]] || [[ "$LINK" == *"error"* ]] || [ -z "$LINK" ]; then
              echo "‚ùå Failed to get stream link: $LINK"
              return 1
            fi
            
            # Clean the link (take first line only)
            LINK=$(echo "$LINK" | head -1)
            echo "‚úÖ Got stream link: ${LINK:0:50}..."
            
            # Detect FPS and set optimal keyframe interval
            detect_fps_and_set_keyframe "$SOURCE"
            KEYFRAME_INTERVAL=$(cat /tmp/keyframe_interval)
            
            echo "üé¨ Starting FFmpeg with keyframe interval = $KEYFRAME_INTERVAL frames (~3.5 seconds)"
            
            # Stream with selected settings and optimized keyframes
            ffmpeg -hide_banner -loglevel warning \
              -re -i "$LINK" \
              -vf "$VF" \
              -af "$AF" \
              -c:v libx264 -preset ultrafast -tune zerolatency \
              -b:v 2500k -maxrate 2500k -bufsize 5000k \
              -g $KEYFRAME_INTERVAL \
              -keyint_min $KEYFRAME_INTERVAL \
              -sc_threshold 0 \
              -c:a aac -b:a 128k -ar 44100 \
              -f flv "$STREAM_URL/$STREAM_KEY" 2>&1 | while read line; do
                echo "[FFMPEG] $line"
              done
            
            local FFMPEG_EXIT=${PIPESTATUS[0]}
            if [ $FFMPEG_EXIT -ne 0 ]; then
              echo "‚ö†Ô∏è FFmpeg exited with code $FFMPEG_EXIT"
            fi
            
            return $FFMPEG_EXIT
          }
          
          # Simple retry loop
          ATTEMPT=1
          MAX_ATTEMPTS=5
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "========== STREAM ATTEMPT $ATTEMPT/$MAX_ATTEMPTS =========="
            
            # Try primary
            if stream_from_source "$URL" "$ATTEMPT"; then
              echo "‚úÖ Stream ended normally"
            else
              echo "‚ö†Ô∏è Primary failed"
              
              # Try backup if available
              if [ ! -z "$BACKUP" ]; then
                echo "üîÑ Trying backup..."
                if stream_from_source "$BACKUP" "$ATTEMPT-backup"; then
                  echo "‚úÖ Backup stream ended"
                else
                  echo "‚ùå Both failed for attempt $ATTEMPT"
                fi
              fi
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            
            if [ $ATTEMPT -le $MAX_ATTEMPTS ]; then
              echo "‚è±Ô∏è  Waiting 10 seconds before retry..."
              sleep 10
            fi
          done
          
          echo ""
          echo "üèÅ Stream session ended after $MAX_ATTEMPTS attempts"
          echo "‚è∞ Time: $(date)"

      - name: üìä Session Summary
        if: always()
        run: |
          echo ""
          echo "========== HONEST STREAM SUMMARY =========="
          echo ""
          echo "‚úÖ What happened:"
          echo "   - Protection level ${{ github.event.inputs.protection_level }} applied"
          echo "   - Output quality: ${{ github.event.inputs.stream_quality }}"
          echo "   - Keyframes optimized to < 4 seconds"
          echo ""
          echo "‚ùå Common issues:"
          echo "   - YouTube blocks GitHub IPs (use VPN/proxy)"
          echo "   - Twitter/X streams need cookies"
          echo "   - GitHub kills processes after ~6 hours"
          echo ""
          echo "üìù Next steps:"
          echo "   1. Check if stream appeared on platform"
          echo "   2. If blocked, try higher protection level"
          echo "   3. Consider using a real VPS server"
          echo "   4. Add cookies for Twitter/X streams"
          echo ""
          echo "============================================"
