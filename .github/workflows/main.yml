name: ğŸ“¡ IRAN NOW - Ultimate Manual Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 1 Ù…Ù† Google Drive', required: true }
      url2: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 2 Ù…Ù† Google Drive', required: true }
      url3: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 3 Ù…Ù† Google Drive', required: true }
      url4: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 4 Ù…Ù† Google Drive', required: true }
      url5: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 5 Ù…Ù† Google Drive', required: true }
      bottom_text: { description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ·', required: false, default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± 24/7' }
      stream_duration: { description: 'Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}
  STREAM_URL: "rtmp://a.rtmp.youtube.com/live2"

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip python3-venv
        pip3 install --upgrade pip
        pip3 install gdown

    - name: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª
      id: timing
      run: |
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        gdown --id 1mcqB-MvngWziGqNPuRs9gO39XtdbddgJ -O background.png || ffmpeg -f lavfi -i color=c=black:s=1920x1080 -frames:v 1 background.png
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ø§Ø­ØªÙŠØ§Ø·ÙŠ (30 Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©)
        ffmpeg -f lavfi -i testsrc=size=640x480:rate=30:duration=30 \
               -f lavfi -i sine=frequency=1000:duration=30 \
               -c:v libx264 -c:a aac -t 30 placeholder.mp4
        
        echo "end_time=$(($(date +%s) + (${{ github.event.inputs.stream_duration }} * 3600)))" >> $GITHUB_OUTPUT

    - name: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Google Drive
      run: |
        # Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ File ID Ù…Ù† Ø±Ø§Ø¨Ø· Google Drive
        extract_file_id() {
          local url="$1"
          if [[ $url =~ /d/([a-zA-Z0-9_-]+) ]]; then
            echo "${BASH_REMATCH[1]}"
          elif [[ $url =~ id=([a-zA-Z0-9_-]+) ]]; then
            echo "${BASH_REMATCH[1]}"
          else
            echo ""
          fi
        }

        # ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        mkdir -p videos
        
        for i in {1..5}; do
          url_var="url$i"
          url="${!url_var}"
          file_id=$(extract_file_id "$url")
          
          echo "ğŸ”„ ØªØ­Ù…ÙŠÙ„ video$i Ù…Ù†: $url"
          
          if [[ -n "$file_id" ]]; then
            # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… gdown
            if gdown --id "$file_id" -O "videos/video$i.mp4"; then
              echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ video$i.mp4 Ø¨Ù†Ø¬Ø§Ø­"
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØºÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ØŒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø®Ø·Ø£)
              filesize=$(stat -c%s "videos/video$i.mp4")
              if [[ $filesize -lt 100000 ]]; then  # Ø£Ù‚Ù„ Ù…Ù† 100KB
                echo "âš ï¸ Ø§Ù„Ù…Ù„Ù ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ ($filesize Ø¨Ø§ÙŠØª)ØŒ Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† ÙÙŠØ¯ÙŠÙˆ ØµØ­ÙŠØ­"
              fi
            else
              echo "âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ video$iØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"
              cp placeholder.mp4 "videos/video$i.mp4"
            fi
          else
            echo "âš ï¸ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­: $url"
            cp placeholder.mp4 "videos/video$i.mp4"
          fi
        done
        
        # Ø¹Ø±Ø¶ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„ØªØ£ÙƒØ¯
        echo "ğŸ“Š Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª:"
        ls -la videos/

    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      run: |
        # Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØ­Ø±Ùƒ
        BOTTOM_TEXT="${{ github.event.inputs.bottom_text }}"
        
        # ÙÙ„ØªØ± Ø¯Ù…Ø¬ Ø§Ù„Ø´Ø§Ø´Ø§Øª
        FILTER="[1:v]scale=960:540,setsar=1[v1]; \
                [2:v]scale=960:540,setsar=1[v2]; \
                [3:v]scale=640:540,setsar=1,format=yuv420p[v3]; \
                [4:v]scale=640:540,setsar=1,format=yuv420p[v4]; \
                [5:v]scale=640:540,setsar=1,format=yuv420p[v5]; \
                [0:v]scale=1920:1080,format=yuv420p[bg]; \
                [bg][v1]overlay=0:0[b1]; \
                [b1][v2]overlay=960:0[b2]; \
                [b2][v3]overlay=0:540[b3]; \
                [b3][v4]overlay=640:540[b4]; \
                [b4][v5]overlay=1280:540[base]; \
                [base]drawtext=text='${BOTTOM_TEXT}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=60:x=w-150*t:y=h-80:box=1:boxcolor=black@0.6:boxborderw=10,format=yuv420p[out]"

        echo "ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø­ØªÙ‰ $(date -d @${{ steps.timing.outputs.end_time }})"
        echo "ğŸš€ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø«: ${{ env.STREAM_URL }}"
        
        while [ $(date +%s) -lt ${{ steps.timing.outputs.end_time }} ]; do
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ $(date)"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø«
          for i in {1..5}; do
            if [[ ! -f "videos/video$i.mp4" ]]; then
              echo "âš ï¸ video$i.mp4 ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"
              cp placeholder.mp4 "videos/video$i.mp4"
            fi
          done
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø«
          ffmpeg -re -stream_loop -1 -i background.png \
            -stream_loop -1 -i videos/video1.mp4 \
            -stream_loop -1 -i videos/video2.mp4 \
            -stream_loop -1 -i videos/video3.mp4 \
            -stream_loop -1 -i videos/video4.mp4 \
            -stream_loop -1 -i videos/video5.mp4 \
            -filter_complex "$FILTER" -map "[out]" -map 1:a? \
            -c:v libx264 -preset ultrafast -tune zerolatency -b:v 2500k -maxrate 2500k -bufsize 5000k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -ar 44100 \
            -f flv "${{ env.STREAM_URL }}/${{ secrets.STREAM_KEY }}"
          
          echo "âš ï¸ ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø«ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ..."
          sleep 5
        done
        
        echo "âœ… Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ù‚Ø±Ø±"
