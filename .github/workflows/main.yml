name: Ultimate Stream 2026
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'فيديو 1 (الأخضر - صامت)', required: true }
      url2: { description: 'فيديو 2 (الأحمر - صامت)', required: true }
      url3: { description: 'فيديو 3 (الأزرق - صوت رئيسي)', required: true }
      bottom_text: { description: 'نص الشريط المتحرك', required: false, default: 'بث مباشر - تغطية مستمرة' }
      stream_duration: { description: 'المدة بالساعات', required: false, default: '6' }

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip
        pip3 install gdown

    - name: Download Videos
      run: |
        extract_id() {
          echo "$1" | sed -E 's/.*(\/d\/|id=)([a-zA-Z0-9_-]+).*/\2/'
        }
        mkdir -p videos
        URLS=("${{ github.event.inputs.url1 }}" "${{ github.event.inputs.url2 }}" "${{ github.event.inputs.url3 }}")
        for i in "${!URLS[@]}"; do
          ID=$(extract_id "${URLS[$i]}")
          gdown --id "$ID" -O "videos/video$((i+1)).mp4" || ffmpeg -f lavfi -i color=c=black:s=1280x720:d=1 -frames:v 1 "videos/video$((i+1)).mp4"
        done

    - name: Start Stream
      env:
        S_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}
      run: |
        DURATION_SEC=$(( ${{ github.event.inputs.stream_duration }} * 3600 ))
        
        ffmpeg -re -loop 1 -framerate 25 -i "background v5.png" \
               -re -stream_loop -1 -i "videos/video1.mp4" \
               -re -stream_loop -1 -i "videos/video2.mp4" \
               -re -stream_loop -1 -i "videos/video3.mp4" \
               -f lavfi -re -i anullsrc=channel_layout=stereo:sample_rate=44100 \
               -filter_complex " \
                [0:v]scale=2560:1440[bg]; \
                [1:v]scale=1100:600:force_original_aspect_ratio=increase,crop=1100:600[v1]; \
                [2:v]scale=1100:600:force_original_aspect_ratio=increase,crop=1100:600[v2]; \
                [3:v]scale=1460:1200:force_original_aspect_ratio=decrease,pad=1460:1200:(ow-iw)/2:(oh-ih)/2:black[v3]; \
                [bg][v1]overlay=x=0:y=0[o1]; \
                [o1][v2]overlay=x=0:y=620[o2]; \
                [o2][v3]overlay=x=1100:y=0[o3]; \
                [o3]drawtext=text='${{ github.event.inputs.bottom_text }}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=85:y=h-115:x=w-mod(t*180\,w+tw)[v_out]; \
                [4:a][3:a]amix=inputs=2:duration=first:dropout_transition=0:weights=0 1[a_out]" \
               -map "[v_out]" \
               -map "[a_out]" \
               -c:v libx264 -preset veryfast -tune zerolatency -threads 4 \
               -b:v 12000k -maxrate 14000k -bufsize 24000k \
               -pix_fmt yuv420p -g 50 \
               -c:a aac -b:a 192k -ar 48000 \
               -f flv -t $DURATION_SEC \
               "rtmp://a.rtmp.youtube.com/live2/$S_KEY"
