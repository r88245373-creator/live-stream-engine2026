name: 24/7 Live Stream (Pro Anti-Bot)24/2/2026

on:
  schedule:
    - cron: '0 */6 * * *' # إعادة تشغيل تلقائية كل 6 ساعات
  workflow_dispatch: # تشغيل يدوي

jobs:
  streaming_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3
        with:
          lfs: true # هام جداً لتحميل ملف الفيديو الأصلي

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Start Stream
        env:
          STREAM_URL: ${{ secrets.STREAM_URL }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          while true; do
            echo "Preparing Playlist..."
            rm -f playlist.txt
            
            # التأكد من وجود مجلد music وملفات mp3
            if [ -d "./music" ]; then
              for f in ./music/*.mp3; do
                echo "file '$PWD/$f'" >> playlist.txt
              done
              shuf playlist.txt -o playlist.txt
            else
              echo "Warning: Music folder not found!"
            fi

            echo "Starting FFmpeg with Hash-Change and Audio Fix..."

            # الأمر المحدث لحل مشكلة الـ Buffering ورمز الخطأ 234
            ffmpeg -re -stream_loop -1 -i "test1-2026.mp4" \
            -f concat -safe 0 -i playlist.txt \
            -c:v libx264 -preset ultrafast -tune zerolatency \
            -x264-params "keyint=60:min-keyint=60:scenecut=-1" \
            -vf "hue=s=1.01" \
            -b:v 4000k -maxrate 4000k -bufsize 8000k -nal-hrd cbr \
            -c:a aac -b:a 128k -ar 44100 -ac 2 \
            -map 0:v:0 -map 1:a:0 -shortest \
            -fflags +genpts+round_timestamps \
            -f flv "$STREAM_URL/$STREAM_KEY"

            echo "Process crashed or stopped. Restarting in 5 seconds..."
            sleep 5
          done
