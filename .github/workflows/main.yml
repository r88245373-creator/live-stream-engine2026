name: ğŸ“¡ IRAN NOW - Ultimate Manual Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 1', required: true }
      url2: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 2', required: true }
      url3: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 3', required: true }
      url4: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 4', required: true }
      url5: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 5', required: true }
      bottom_text: { description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ·', required: false, default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± 24/7' }
      stream_duration: { description: 'Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip python3-venv
        
        # ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        sudo apt-get install -y \
          curl \
          wget \
          libcurl4-openssl-dev \
          libssl-dev \
          python3-dev \
          build-essential \
          pkg-config
        
        # ØªØ­Ø¯ÙŠØ« pip ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª
        pip3 install --upgrade pip
        pip3 install --upgrade curl-cffi
        pip3 install --upgrade "yt-dlp[default,curl-cffi]" brotli certifi gdown
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        ffmpeg -f lavfi -i testsrc=size=640x480:rate=30:duration=300 \
               -f lavfi -i sine=frequency=1000:duration=300 \
               -c:v libx264 -c:a aac -t 300 placeholder.mp4

    - name: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª
      id: timing
      run: |
        gdown --id 1mcqB-MvngWziGqNPuRs9gO39XtdbddgJ -O background.png || ffmpeg -f lavfi -i color=c=black:s=1920x1080 -frames:v 1 background.png
        echo "end_time=$(($(date +%s) + (${{ github.event.inputs.stream_duration }} * 3600)))" >> $GITHUB_OUTPUT

    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      run: |
        # Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        extract_url() {
          local url="$1"
          local output=""
          
          echo "ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬: $url" >&2
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ yt-dlp
          for impersonate in "chrome:windows-10" "firefox:windows-10" "safari:macos-11"; do
            output=$(yt-dlp --quiet --no-warnings --get-url \
              --impersonate "$impersonate" \
              --extractor-args "generic:impersonate=$impersonate" \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              --referer "https://www.google.com/" \
              "$url" 2>/dev/null | head -1)
            
            if [[ -n "$output" ]]; then
              echo "âœ… Ù†Ø¬Ø­ Ù…Ø¹ impersonate: $impersonate" >&2
              echo "$output"
              return 0
            fi
          done
          
          echo "âš ï¸ ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ $urlØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… placeholder" >&2
          echo "placeholder"
        }

        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        echo "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ..."
        
        URL1="${{ github.event.inputs.url1 }}"
        URL2="${{ github.event.inputs.url2 }}"
        URL3="${{ github.event.inputs.url3 }}"
        URL4="${{ github.event.inputs.url4 }}"
        URL5="${{ github.event.inputs.url5 }}"
        
        V1=$(extract_url "$URL1")
        V2=$(extract_url "$URL2")
        V3=$(extract_url "$URL3")
        V4=$(extract_url "$URL4")
        V5=$(extract_url "$URL5")
        
        echo "V1: $V1"
        echo "V2: $V2"
        echo "V3: $V3"
        echo "V4: $V4"
        echo "V5: $V5"

        # ÙÙ„ØªØ± Ø¯Ù…Ø¬ Ø§Ù„Ø´Ø§Ø´Ø§Øª (Ø¨Ø¯ÙˆÙ† Ø®Ø·ÙˆØ· Ù…Ø§Ø¦Ù„Ø©)
        FILTER="[1:v]scale=960:540,setsar=1[v1]; [2:v]scale=960:540,setsar=1[v2]; [3:v]scale=640:540,setsar=1[v3]; [4:v]scale=640:540,setsar=1[v4]; [5:v]scale=640:540,setsar=1[v5]; [0:v]scale=1920:1080[bg]; [bg][v1]overlay=0:0[b1]; [b1][v2]overlay=960:0[b2]; [b2][v3]overlay=0:540[b3]; [b3][v4]overlay=640:540[b4]; [b4][v5]overlay=1280:540[b5]; [b5]drawtext=text='${{ github.event.inputs.bottom_text }}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=60:x=w-mod(150*t,w+tw):y=h-80:box=1:boxcolor=black@0.6[out]"

        # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
        echo "ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø­ØªÙ‰ $(date -d @${{ steps.timing.outputs.end_time }})"
        
        while [ $(date +%s) -lt ${{ steps.timing.outputs.end_time }} ]; do
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ $(date)"
          
          # ØªØ­Ø¶ÙŠØ± Ù…Ø¯Ø®Ù„Ø§Øª ffmpeg
          ffmpeg -re -stream_loop -1 -i background.png \
            -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -timeout 30000000 -rw_timeout 30000000 \
            -i "$V1" \
            -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -timeout 30000000 -rw_timeout 30000000 \
            -i "$V2" \
            -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -timeout 30000000 -rw_timeout 30000000 \
            -i "$V3" \
            -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -timeout 30000000 -rw_timeout 30000000 \
            -i "$V4" \
            -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -timeout 30000000 -rw_timeout 30000000 \
            -i "$V5" \
            -filter_complex "$FILTER" -map "[out]" -map 1:a \
            -c:v libx264 -preset ultrafast -tune zerolatency -b:v 2500k -maxrate 2500k -bufsize 5000k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -ar 44100 \
            -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY" || {
            
            echo "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø¨Ø«ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©..."
            sleep 5
            
            # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙØ§Ø´Ù„Ø© ÙÙ‚Ø·
            if [[ "$V2" == "placeholder" ]] || [[ "$V2" == *"gledaitv"* ]]; then
              echo "Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· 2..."
              V2=$(extract_url "$URL2")
            fi
          }
          
          sleep 2
        done
        
        echo "âœ… Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ù‚Ø±Ø±"
