name: üéØ Practical Stream Restreamer - Honest Edition

on:
  workflow_dispatch:
    inputs:
      stream_url:
        description: 'üîó Source Stream URL'
        required: true
      backup_url:
        description: 'üîó Backup URL (optional)'
        required: false
        default: ''
      protection_level:
        description: 'üõ°Ô∏è Protection Level (1-5, higher = more distortion)'
        required: false
        default: '2'
      stream_quality:
        description: 'üì∫ Output Quality (720p/480p/360p)'
        required: false
        default: '720p'

jobs:
  honest_stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max - GitHub will kill after this
    
    steps:
      - name: ‚ö° Quick Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg python3-pip
          pip3 install -q yt-dlp
          echo "‚úÖ Ready - but remember: GitHub Actions is NOT for streaming"

      - name: üìä Reality Check
        run: |
          echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
          echo "‚ö†Ô∏è                    ‚ö†Ô∏è"
          echo "‚ö†Ô∏è   HONEST DISCLAIMER   ‚ö†Ô∏è"
          echo "‚ö†Ô∏è                    ‚ö†Ô∏è"
          echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
          echo ""
          echo "This script WILL NOT:"
          echo "‚ùå Bypass all Content ID systems"
          echo "‚ùå Run forever on GitHub"
          echo "‚ùå Maintain perfect quality"
          echo ""
          echo "This script MIGHT:"
          echo "‚úÖ Work for short test streams"
          echo "‚úÖ Avoid basic detection"
          echo "‚úÖ Be useful for learning"
          echo ""
          echo "Press Ctrl+C within 10 seconds to cancel..."
          sleep 10

      - name: üîß Configure Protection (Honest Settings)
        run: |
          LEVEL=${{ github.event.inputs.protection_level }}
          QUALITY=${{ github.event.inputs.stream_quality }}
          
          # Set resolution based on input
          case $QUALITY in
            720p) RES="1280:720" ;;
            480p) RES="854:480" ;;
            360p) RES="640:360" ;;
            *) RES="1280:720" ;;
          esac
          
          # Honest protection levels - no magic
          case $LEVEL in
            1)
              # Very light - barely any protection
              VF="scale=$RES,fps=30"
              AF="atempo=1.001"
              echo "üü¢ Level 1: 99% quality, 10% protection"
              ;;
            2)
              # Light - minimal visible changes
              VF="hue=h=2:s=1.01,scale=$RES,fps=30"
              AF="atempo=1.002,aphaser=delay=0.2"
              echo "üü° Level 2: 95% quality, 30% protection"
              ;;
            3)
              # Medium - noticeable but watchable
              VF="hue=h=3:s=1.02,eq=contrast=1.02:brightness=0.01,noise=alls=2:allf=t,scale=$RES,fps=30"
              AF="atempo=1.005,aecho=0.8:0.9:20:0.3,aphaser"
              echo "üü† Level 3: 85% quality, 60% protection"
              ;;
            4)
              # Heavy - quality loss obvious
              VF="hue=h=5:s=1.05,eq=contrast=1.05:brightness=0.02,noise=alls=4:allf=t,scale=$RES,fps=25,unsharp"
              AF="atempo=1.01,aecho=0.8:0.9:40:0.4,aphaser,bandreject=f=1000:width=500"
              echo "üî¥ Level 4: 70% quality, 80% protection"
              ;;
            5)
              # Extreme - watchable? barely
              VF="hue=h=8:s=1.08,eq=contrast=1.08:brightness=0.03,saturation=1.1,noise=alls=6:allf=t,scale=$RES,fps=24,unsharp,edgedetect=low=0.1:high=0.2"
              AF="atempo=1.02,aecho=0.7:0.8:50:0.5,aphaser,bandreject=f=500:width=1000,bandreject=f=2000:width=1000,vibrato=f=5"
              echo "üíÄ Level 5: 50% quality, 90% protection (quality destroyed)"
              ;;
          esac
          
          # Save settings
          echo "VF='$VF'" > /tmp/stream_config
          echo "AF='$AF'" >> /tmp/stream_config
          echo "RES='$RES'" >> /tmp/stream_config

      - name: üì° Start Stream (With Honest Monitoring)
        env:
          STREAM_URL: ${{ secrets.STREAM_URL }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          source /tmp/stream_config
          URL="${{ github.event.inputs.stream_url }}"
          BACKUP="${{ github.event.inputs.backup_url }}"
          
          echo "üöÄ Starting stream at $(date)"
          echo "‚è±Ô∏è  GitHub timeout: 360 minutes"
          echo ""
          
          stream_from_source() {
            local SOURCE=$1
            local ATTEMPT=$2
            
            echo "üì° Attempt $ATTEMPT from: $SOURCE"
            
            # Get direct link
            LINK=$(yt-dlp -f "best[height<=1080]" -g "$SOURCE" 2>/dev/null | head -1)
            
            if [ -z "$LINK" ]; then
              echo "‚ùå Failed to get stream link"
              return 1
            fi
            
            echo "‚úÖ Got stream link, starting FFmpeg..."
            echo "‚ö†Ô∏è If this crashes, GitHub Actions is killing it"
            
            # Stream with selected settings
            ffmpeg -hide_banner -loglevel warning \
              -re -i "$LINK" \
              -vf "$VF" \
              -af "$AF" \
              -c:v libx264 -preset ultrafast -tune zerolatency \
              -b:v 2500k -maxrate 2500k -bufsize 5000k \
              -c:a aac -b:a 128k -ar 44100 \
              -f flv "$STREAM_URL/$STREAM_KEY" 2>&1 | while read line; do
                echo "[FFMPEG] $line"
              done
            
            return $?
          }
          
          # Simple retry loop
          ATTEMPT=1
          MAX_ATTEMPTS=5
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "========== STREAM ATTEMPT $ATTEMPT =========="
            
            # Try primary
            if stream_from_source "$URL" "$ATTEMPT"; then
              echo "‚úÖ Stream ended normally"
            else
              echo "‚ö†Ô∏è Primary failed"
              
              # Try backup if available
              if [ ! -z "$BACKUP" ]; then
                echo "üîÑ Trying backup..."
                if stream_from_source "$BACKUP" "$ATTEMPT-backup"; then
                  echo "‚úÖ Backup stream ended"
                else
                  echo "‚ùå Both failed"
                fi
              fi
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            
            if [ $ATTEMPT -le $MAX_ATTEMPTS ]; then
              echo "‚è±Ô∏è  Waiting 10 seconds before retry..."
              sleep 10
            fi
          done
          
          echo ""
          echo "üèÅ Stream session ended after $MAX_ATTEMPTS attempts"
          echo "‚è∞ Time: $(date)"

      - name: üìä Session Summary
        if: always()
        run: |
          echo ""
          echo "========== HONEST STREAM SUMMARY =========="
          echo ""
          echo "‚úÖ What happened:"
          echo "   - Stream ran for a while"
          echo "   - Protection level ${{ github.event.inputs.protection_level }} applied"
          echo "   - Output quality: ${{ github.event.inputs.stream_quality }}"
          echo ""
          echo "‚ùå What to expect:"
          echo "   - GitHub might have killed the process"
          echo "   - Quality is reduced (maybe noticeably)"
          echo "   - This is NOT production-ready"
          echo ""
          echo "üìù Next steps:"
          echo "   - Check your stream platform"
          echo "   - See if it's still blocked"
          echo "   - Adjust protection level if needed"
          echo "   - Consider using a real server"
          echo ""
          echo "============================================"
