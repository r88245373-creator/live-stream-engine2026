name: ğŸ“¡ IRAN NOW - Ultimate Pro Stream 4K
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 1 (Ø§Ù„Ø£Ø®Ø¶Ø±)', required: true }
      url2: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 2 (Ø§Ù„Ø£Ø­Ù…Ø±)', required: true }
      url3: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 3 (Ø§Ù„Ø£ØµÙØ±)', required: true }
      url4: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 4 (Ø§Ù„Ø£Ø²Ø±Ù‚)', required: true }
      url5: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 5 (Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ)', required: true }
      bottom_text: { description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØ­Ø±Ùƒ', required: false, default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± 24/7 - ØªØºØ·ÙŠØ© Ù…Ø³ØªÙ…Ø±Ø©' }
      stream_duration: { description: 'Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª', required: false, default: '6' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}
  STREAM_URL: "rtmps://a.rtmp.youtube.com:443/live2"

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip
        pip3 install gdown

    - name: Download Videos
      run: |
        extract_id() {
          echo "$1" | sed -E 's/.*(\/d\/|id=)([a-zA-Z0-9_-]+).*/\2/'
        }
        mkdir -p videos
        # Ø¬Ù„Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        URLS=("${{ github.event.inputs.url1 }}" "${{ github.event.inputs.url2 }}" "${{ github.event.inputs.url3 }}" "${{ github.event.inputs.url4 }}" "${{ github.event.inputs.url5 }}")
        
        for i in "${!URLS[@]}"; do
          ID=$(extract_id "${URLS[$i]}")
          echo "ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ $((i+1))..."
          gdown --id "$ID" -O "videos/video$((i+1)).mp4" || ffmpeg -f lavfi -i color=c=black:s=640x480:d=1 -frames:v 1 "videos/video$((i+1)).mp4"
        done

    - name: Start Live Stream (Ultra Fast Mode)
      run: |
        DURATION_SEC=$(( ${{ github.event.inputs.stream_duration }} * 3600 ))
        STREAM_URL_FULL="${{ env.STREAM_URL }}/${{ env.STREAM_KEY }}"
        B_TEXT="${{ github.event.inputs.bottom_text }}"
        export TZ="Asia/Tehran"

        # Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… -preset ultrafast Ùˆ -threads 0 Ù„Ø±ÙØ¹ Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù„Ù‰ 1x
        ffmpeg -re -stream_loop -1 -i "pro dashboard v2.0.png" \
               -re -stream_loop -1 -i "videos/video1.mp4" \
               -re -stream_loop -1 -i "videos/video2.mp4" \
               -re -stream_loop -1 -i "videos/video3.mp4" \
               -re -stream_loop -1 -i "videos/video4.mp4" \
               -re -stream_loop -1 -i "videos/video5.mp4" \
               -filter_complex " \
                [1:v]scale=1920:1000:force_original_aspect_ratio=decrease,pad=1920:1000:(ow-iw)/2:(oh-ih)/2[v1]; \
                [2:v]scale=1920:1000:force_original_aspect_ratio=decrease,pad=1920:1000:(ow-iw)/2:(oh-ih)/2[v2]; \
                [3:v]scale=1520:940:force_original_aspect_ratio=decrease,pad=1520:940:(ow-iw)/2:(oh-ih)/2[v3]; \
                [4:v]scale=1540:940:force_original_aspect_ratio=decrease,pad=1540:940:(ow-iw)/2:(oh-ih)/2[v4]; \
                [5:v]scale=780:940:force_original_aspect_ratio=decrease,pad=780:940:(ow-iw)/2:(oh-ih)/2[v5]; \
                [0:v][v1]overlay=x=0:y=0[b1]; \
                [b1][v2]overlay=x=1920:y=0[b2]; \
                [b2][v3]overlay=x=0:y=1000[b3]; \
                [b3][v4]overlay=x=1520:y=1000[b4]; \
                [b4][v5]overlay=x=3060:y=1000[b5]; \
                [b5]drawtext=text='%{localtime\:%H\\\\\:%M\\\\\:%S}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=yellow:fontsize=60:x=w-320:y=50:box=1:boxcolor=black@0.6[clk]; \
                [clk]drawtext=text='${B_TEXT}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=90:y=h-135:x=w-mod(t*200\,w+tw)[out]" \
               -map "[out]" \
               -map 1:a? \
               -c:v libx264 -preset ultrafast -tune zerolatency -threads 0 \
               -b:v 4000k -maxrate 4000k -bufsize 8000k \
               -pix_fmt yuv420p -g 50 \
               -c:a aac -b:a 128k -ar 44100 \
               -f flv -t $DURATION_SEC \
               "$STREAM_URL_FULL"
