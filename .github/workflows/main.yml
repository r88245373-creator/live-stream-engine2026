name: 24/7 Live Stream (Pro Anti-Bot)

on:
  schedule:
    - cron: '0 */6 * * *' # Automatically restarts every 6 hours to ensure 24/7 stability
  workflow_dispatch: # Allows you to manually trigger the stream at any time

jobs:
  streaming_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3
        with:
          lfs: true # CRITICAL: This pulls the actual 100MB+ test1-2026.mp4 file instead of a pointer

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Start Stream
        env:
          STREAM_URL: ${{ secrets.STREAM_URL }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          # Infinite loop to keep the process alive and handle restarts
          while true; do

            echo "Generating new shuffled playlist..."
            rm -f playlist.txt

            # Create a playlist from all MP3 files in the 'music' folder
            for f in ./music/*.mp3; do
              echo "file '$PWD/$f'" >> playlist.txt
            done

            # Shuffle the playlist for a fresh audio experience every time
            shuf playlist.txt -o playlist.txt

            echo "Starting FFmpeg stream..."

            # Main FFmpeg command updated with Keyframe Fix
            ffmpeg -re -stream_loop -1 -i "test1-2026.mp4" \
            -f concat -safe 0 -i playlist.txt \
            -c:v libx264 -preset ultrafast -tune zerolatency \
            -x264-params "keyint=60:min-keyint=60:scenecut=-1" \
            -b:v 4000k -maxrate 4000k -bufsize 8000k -nal-hrd cbr \
            -c:a aac -b:a 128k -ar 44100 \
            -map 0:v -map 1:a -fflags +genpts \
            -f flv "$STREAM_URL/$STREAM_KEY"

            echo "FFmpeg stopped. Restarting with new shuffle in 5 seconds..."
            sleep 5
          done
