name: 24/7 Live Stream (Ultra Pro Anti-Bot) 25/2/2026

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  streaming_job:
    runs-on: ubuntu-latest
    concurrency:
      group: production-stream
      cancel-in-progress: true

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3
        with:
          lfs: false

      - name: Install FFmpeg and Wget
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg wget

      - name: Download Video with Fallback
        run: |
          FILE_ID="18qEAmXXMd4B28RazEPdMCltSDc6KVB48"
          OUTPUT="test1-2026.mp4"

          echo "Downloading Google Drive file..."

          # Download Google Drive directly with confirmation token handling
          CONFIRM=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate \
            "https://docs.google.com/uc?export=download&id=${FILE_ID}" -O- | \
            sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1/p')

          if wget --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=${CONFIRM}&id=${FILE_ID}" -O ${OUTPUT}; then
              echo "Download successful."
          else
              echo "Download failed. Using backup.mp4"
              if [ -f "backup.mp4" ]; then
                cp backup.mp4 test1-2026.mp4
              else
                echo "No backup video found!"
                exit 1
              fi
          fi

          # Verify file integrity
          if ! ffmpeg -v error -i ${OUTPUT} -f null - 2>/dev/null; then
            echo "Corrupted video detected! Using backup..."
            if [ -f "backup.mp4" ]; then
              cp backup.mp4 test1-2026.mp4
            else
              echo "No backup video found!"
              exit 1
            fi
          fi

      - name: Start Stream
        env:
          STREAM_URL: ${{ secrets.STREAM_URL }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          while true; do
            echo "Preparing Playlist..."
            rm -f playlist.txt temp.txt shuffled.txt

            if [ ! -d "./music" ]; then
              echo "Music folder not found!"
              exit 1
            fi

            find ./music -type f -name "*.mp3" > temp.txt

            if [ ! -s temp.txt ]; then
              echo "No mp3 files found!"
              exit 1
            fi

            shuf temp.txt > shuffled.txt

            while read f; do
              echo "file '$PWD/$f'" >> playlist.txt
            done < shuffled.txt

            echo "Generating subtle dynamic filters..."
            BRIGHT=$(awk -v min=-0.02 -v max=0.02 'BEGIN{srand(); print min+rand()*(max-min)}')
            CONTRAST=$(awk -v min=0.98 -v max=1.02 'BEGIN{srand(); print min+rand()*(max-min)}')
            SAT=$(awk -v min=0.98 -v max=1.02 'BEGIN{srand(); print min+rand()*(max-min)}')

            echo "Starting FFmpeg..."

            ffmpeg -re -stream_loop -1 -i "test1-2026.mp4" \
            -f concat -safe 0 -thread_queue_size 512 -i playlist.txt \
            -map 0:v:0 -map 1:a \
            -c:v libx264 -preset veryfast -tune zerolatency \
            -threads 2 \
            -x264-params "keyint=60:min-keyint=60:scenecut=-1" \
            -vf "eq=brightness=${BRIGHT}:contrast=${CONTRAST}:saturation=${SAT}" \
            -b:v 3500k -maxrate 3500k -bufsize 7000k -nal-hrd cbr \
            -pix_fmt yuv420p \
            -c:a aac -b:a 128k -ar 44100 -ac 2 \
            -af "volume=0.01,aresample=async=1:min_hard_comp=0.100:first_pts=0" \
            -map_metadata -1 \
            -max_muxing_queue_size 1024 \
            -fflags +genpts \
            -f flv "${STREAM_URL}${STREAM_KEY}"

            echo "FFmpeg stopped. Restarting in 5 seconds..."
            sleep 5
          done
