name: ğŸ“¡ IRAN NOW - Ultimate Manual Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 1 Ù…Ù† Google Drive', required: true }
      url2: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 2 Ù…Ù† Google Drive', required: true }
      url3: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 3 Ù…Ù† Google Drive', required: true }
      url4: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 4 Ù…Ù† Google Drive', required: true }
      url5: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 5 Ù…Ù† Google Drive', required: true }
      bottom_text: { description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ·', required: false, default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± 24/7' }
      stream_duration: { description: 'Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}
  STREAM_URL: "rtmps://a.rtmp.youtube.com:443/live2"
  URL1: ${{ github.event.inputs.url1 }}
  URL2: ${{ github.event.inputs.url2 }}
  URL3: ${{ github.event.inputs.url3 }}
  URL4: ${{ github.event.inputs.url4 }}
  URL5: ${{ github.event.inputs.url5 }}
  BOTTOM_TEXT: ${{ github.event.inputs.bottom_text }}
  STREAM_DURATION: ${{ github.event.inputs.stream_duration }}

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip
        pip3 install --upgrade pip
        pip3 install gdown

    - name: Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
      run: |
        echo "ğŸ“Œ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:"
        echo "URL1: ${{ env.URL1 }}"
        echo "URL2: ${{ env.URL2 }}"
        echo "URL3: ${{ env.URL3 }}"
        echo "URL4: ${{ env.URL4 }}"
        echo "URL5: ${{ env.URL5 }}"

    - name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Stream Key
      run: |
        if [ -z "${{ secrets.YOUTUBE_STREAM_KEY }}" ]; then
          echo "âŒ ERROR: YOUTUBE_STREAM_KEY is not set in GitHub Secrets!"
          exit 1
        else
          echo "âœ… YOUTUBE_STREAM_KEY is set (length: ${#STREAM_KEY})"
        fi

    - name: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª
      id: timing
      run: |
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ background2026.png ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        if [[ ! -f "background2026.png" ]]; then
          echo "âš ï¸ background2026.png ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡"
          ffmpeg -f lavfi -i color=c=black:s=3840x2160 -frames:v 1 background2026.png
        else
          echo "âœ… background2026.png Ù…ÙˆØ¬ÙˆØ¯"
        fi
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        ffmpeg -f lavfi -i testsrc=size=640x480:rate=30:duration=30 \
               -f lavfi -i sine=frequency=1000:duration=30 \
               -c:v libx264 -c:a aac -t 30 placeholder.mp4
        
        # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        END_TIME=$(($(date +%s) + (${{ env.STREAM_DURATION }} * 3600)))
        echo "END_TIME=$END_TIME" >> $GITHUB_ENV

    - name: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Google Drive
      run: |
        # Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ File ID Ù…Ù† Ø±Ø§Ø¨Ø· Google Drive
        extract_file_id() {
          local url="$1"
          if [[ $url =~ /d/([a-zA-Z0-9_-]+) ]]; then
            echo "${BASH_REMATCH[1]}"
          elif [[ $url =~ id=([a-zA-Z0-9_-]+) ]]; then
            echo "${BASH_REMATCH[1]}"
          else
            echo ""
          fi
        }

        # ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        mkdir -p videos
        
        # Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        urls=("${{ env.URL1 }}" "${{ env.URL2 }}" "${{ env.URL3 }}" "${{ env.URL4 }}" "${{ env.URL5 }}")
        
        for i in {0..4}; do
          url="${urls[$i]}"
          video_num=$((i+1))
          
          echo "ğŸ”„ ØªØ­Ù…ÙŠÙ„ video$video_num Ù…Ù†: $url"
          
          if [[ -z "$url" || "$url" == "null" ]]; then
            echo "âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙØ§Ø±ØºØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"
            cp placeholder.mp4 "videos/video$video_num.mp4"
            continue
          fi
          
          file_id=$(extract_file_id "$url")
          
          if [[ -n "$file_id" ]]; then
            echo "ğŸ“‹ File ID: $file_id"
            if gdown --id "$file_id" -O "videos/video$video_num.mp4"; then
              echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ video$video_num.mp4"
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
              if [[ -f "videos/video$video_num.mp4" ]]; then
                filesize=$(stat -c%s "videos/video$video_num.mp4")
                if [[ $filesize -lt 100000 ]]; then
                  echo "âš ï¸ Ø§Ù„Ù…Ù„Ù ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ ($filesize Ø¨Ø§ÙŠØª)ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"
                  cp placeholder.mp4 "videos/video$video_num.mp4"
                fi
              fi
            else
              echo "âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"
              cp placeholder.mp4 "videos/video$video_num.mp4"
            fi
          else
            echo "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ File ID ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·"
            echo "ğŸ“ Ù…Ø«Ø§Ù„ Ù„Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­: https://drive.google.com/file/d/FILE_ID/view"
            cp placeholder.mp4 "videos/video$video_num.mp4"
          fi
        done
        
        echo "ğŸ“Š Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:"
        ls -la videos/

    - name: Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ù…Ø±ÙƒØ¨ Ù…Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©
      run: |
        echo "ğŸ¬ Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ù…Ø±ÙƒØ¨ Ù…Ù† 5 Ø´Ø§Ø´Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… background2026.png..."
        
        # Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØ­Ø±Ùƒ
        BOTTOM_TEXT="${{ env.BOTTOM_TEXT }}"
        
        # ÙÙ„ØªØ± Ø¯Ù…Ø¬ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨
        FILTER="[1:v]scale=1920:1000[green]; \
                [2:v]scale=1920:1000[red]; \
                [3:v]scale=1520:940[yellow]; \
                [4:v]scale=1540:940[blue]; \
                [5:v]scale=780:940[grey]; \
                [0:v][green]overlay=x=0:y=0[b1]; \
                [b1][red]overlay=x=1920:y=0[b2]; \
                [b2][yellow]overlay=x=0:y=1000[b3]; \
                [b3][blue]overlay=x=1520:y=1000[b4]; \
                [b4][grey]overlay=x=3060:y=1000[b5]; \
                [b5]drawtext=text='${BOTTOM_TEXT}':fontcolor=red:fontsize=110:borderw=3:bordercolor=red:y=2050+((2160-2050-th)/2):x=-tw+mod(t*220\,w+tw)[out]"
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø­Ø¯ Ù„Ù…Ø¯Ø© 30 Ø«Ø§Ù†ÙŠØ©
        ffmpeg -i background2026.png \
               -i videos/video1.mp4 \
               -i videos/video2.mp4 \
               -i videos/video3.mp4 \
               -i videos/video4.mp4 \
               -i videos/video5.mp4 \
               -filter_complex "$FILTER" -map "[out]" -map 1:a? \
               -c:v libx264 -preset fast -b:v 6800k -maxrate 6800k -bufsize 13600k \
               -c:a aac -b:a 192k -ar 44100 \
               -t 30 -y combined.mp4
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø±ÙƒØ¨"
        echo "ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø±ÙƒØ¨:"
        ffprobe -v quiet -show_entries stream=width,height -of default=noprint_wrappers=1 combined.mp4

    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©
      run: |
        END_TIME="${{ env.END_TIME }}"
        STREAM_URL_FULL="${{ env.STREAM_URL }}/${{ secrets.YOUTUBE_STREAM_KEY }}"
        
        echo "ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø­ØªÙ‰ $(date -d @$END_TIME)"
        echo "ğŸš€ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø«: $STREAM_URL_FULL"
        echo "ğŸ¯ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«: 1080p @ 6800 Kbps (Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù…Ù† YouTube)"
        
        while [ $(date +%s) -lt $END_TIME ]; do
          REMAINING=$(( END_TIME - $(date +%s) ))
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Ø¯ÙˆØ±Ø© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø© - $(date)"
          echo "â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: $((REMAINING / 3600))h $(((REMAINING % 3600) / 60))m"
          echo "ğŸ“¡ Ø§Ù„Ø¨Ø« Ø¥Ù„Ù‰: $STREAM_URL_FULL"
          echo "ğŸ¬ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«: 1080p | 6800 Kbps | AAC 192k"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Ø§Ù„Ø¨Ø« Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©
          ffmpeg -hide_banner -loglevel warning -re -stream_loop -1 \
            -i combined.mp4 \
            -c:v libx264 -preset veryfast -tune zerolatency \
            -b:v 6800k -maxrate 6800k -bufsize 13600k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 192k -ar 44100 \
            -f flv -t $REMAINING \
            "$STREAM_URL_FULL" || (echo "âš ï¸ Connection lost. Retrying in 5s..." && sleep 5)
        done
        
        echo "âœ… Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ù‚Ø±Ø±"
