name: ๐ก IRAN NOW - Ultimate Manual Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'ุฑุงุจุท ููุฏูู 1', required: true }
      url2: { description: 'ุฑุงุจุท ููุฏูู 2', required: true }
      url3: { description: 'ุฑุงุจุท ููุฏูู 3', required: true }
      url4: { description: 'ุฑุงุจุท ููุฏูู 4', required: true }
      url5: { description: 'ุฑุงุจุท ููุฏูู 5', required: true }
      bottom_text: { description: 'ูุต ุงูุดุฑูุท', required: false, default: 'ุจุซ ูุจุงุดุฑ 24/7' }
      stream_duration: { description: 'ุงููุฏุฉ ุจุงูุณุงุนุงุช', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ุชุซุจูุช ุงููุชุทูุจุงุช ุงููุงููุฉ
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip python3-venv
        
        # ุชุซุจูุช ููุชุจุงุช ุงููุธุงู
        sudo apt-get install -y \
          curl \
          wget \
          libcurl4-openssl-dev \
          libssl-dev \
          python3-dev \
          build-essential \
          pkg-config
        
        # ุชุญุฏูุซ pip ูุชุซุจูุช ุงูุฃุฏูุงุช
        pip3 install --upgrade pip
        pip3 install --upgrade curl-cffi
        pip3 install --upgrade "yt-dlp[default,curl-cffi]" brotli certifi gdown

    - name: ุชุฌููุฒ ุงูุฎูููุฉ ูุงูุชูููุช
      id: timing
      run: |
        # ุชุญููู ุงูุฎูููุฉ ุงูุฑุฆูุณูุฉ
        gdown --id 1mcqB-MvngWziGqNPuRs9gO39XtdbddgJ -O background.png || ffmpeg -f lavfi -i color=c=black:s=1920x1080 -frames:v 1 background.png
        
        # ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุตูุฑุฉ ุงูุงุญุชูุงุทูุฉ ูุชุญููููุง ุฅูู ููุณ ูุณุจุฉ ุงูุฃุจุนุงุฏ
        if [[ ! -f "background2026.png" ]]; then
          echo "โ๏ธ ุงูุตูุฑุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ููุฌูุฏุฉุ ุณูุชู ุฅูุดุงุก ุตูุฑุฉ ุณูุฏุงุก"
          ffmpeg -f lavfi -i color=c=black:s=640x480 -frames:v 1 background2026.png
        else
          # ุชุญููู ุงูุตูุฑุฉ ุงูุงุญุชูุงุทูุฉ ุฅูู ูุณุจุฉ ุฃุจุนุงุฏ 4:3 (640x480) ูุชุชูุงุณุจ ูุน ุงูููุฏูู
          ffmpeg -i background2026.png -vf "scale=640:480:force_original_aspect_ratio=1,pad=640:480:(ow-iw)/2:(oh-ih)/2" -y background2026_fixed.png
          mv background2026_fixed.png background2026.png
        fi
        
        echo "end_time=$(($(date +%s) + (${{ github.event.inputs.stream_duration }} * 3600)))" >> $GITHUB_OUTPUT

    - name: ุจุฏุก ุงูุจุซ ุงููุจุงุดุฑ
      run: |
        # ุฏุงูุฉ ุงุณุชุฎุฑุงุฌ ุงูุฑูุงุจุท ูุน ูุญุงูุงุฉ ุงููุชุตูุญ
        extract_url() {
          local url="$1"
          local output=""
          
          echo "๐ ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ: $url" >&2
          
          # ูุญุงููุงุช ูุชุนุฏุฏุฉ ูุน impersonation
          for impersonate in "chrome:windows-10" "firefox:windows-10" "safari:macos-11"; do
            output=$(yt-dlp --quiet --no-warnings --get-url \
              --impersonate "$impersonate" \
              --extractor-args "generic:impersonate=$impersonate" \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              --referer "https://www.google.com/" \
              "$url" 2>/dev/null | head -1)
            
            if [[ -n "$output" ]]; then
              echo "โ ูุฌุญ ูุน impersonate: $impersonate" >&2
              echo "$output"
              return 0
            fi
          done
          
          # ุฅุฐุง ูุดู ูู ุดูุกุ ุงุณุชุฎุฏู ุงูุตูุฑุฉ ุงูุงุญุชูุงุทูุฉ
          echo "โ๏ธ ูุดู ุงุณุชุฎุฑุงุฌ $urlุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุตูุฑุฉ ุงูุงุญุชูุงุทูุฉ" >&2
          echo "background2026.png"
        }

        # ุฏุงูุฉ ูุชุญุถูุฑ ูุฏุฎู ffmpeg
        prepare_input() {
          local url="$1"
          
          if [[ "$url" == "background2026.png" ]]; then
            # ุตูุฑุฉ ุซุงุจุชุฉ - ูุญูููุง ุฅูู ููุฏูู ูุชูุฑุฑ
            echo "-stream_loop -1 -i \"$url\""
          else
            # ุฑุงุจุท ููุฏูู ุฎุงุฑุฌู - ูุน ุฎูุงุฑุงุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู
            echo "-reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 -timeout 30000000 -rw_timeout 30000000 -i \"$url\""
          fi
        }

        # ุงุณุชุฎุฑุงุฌ ุฌููุน ุงูุฑูุงุจุท
        echo "๐ ุฌุงุฑู ุงุณุชุฎุฑุงุฌ ุฑูุงุจุท ุงูููุฏูู..."
        
        URL1="${{ github.event.inputs.url1 }}"
        URL2="${{ github.event.inputs.url2 }}"
        URL3="${{ github.event.inputs.url3 }}"
        URL4="${{ github.event.inputs.url4 }}"
        URL5="${{ github.event.inputs.url5 }}"
        
        V1=$(extract_url "$URL1")
        V2=$(extract_url "$URL2")
        V3=$(extract_url "$URL3")
        V4=$(extract_url "$URL4")
        V5=$(extract_url "$URL5")
        
        echo "V1: $V1"
        echo "V2: $V2"
        echo "V3: $V3"
        echo "V4: $V4"
        echo "V5: $V5"

        # ูุต ุงูุดุฑูุท ุงููุชุญุฑู
        BOTTOM_TEXT="${{ github.event.inputs.bottom_text }}"
        
        # ููุชุฑ ุฏูุฌ ุงูุดุงุดุงุช ุงููุญุณู
        FILTER="[1:v]scale=960:540,setsar=1[v1]; \
                [2:v]scale=960:540,setsar=1[v2]; \
                [3:v]scale=640:540,setsar=1,format=yuv420p[v3]; \
                [4:v]scale=640:540,setsar=1,format=yuv420p[v4]; \
                [5:v]scale=640:540,setsar=1,format=yuv420p[v5]; \
                [0:v]scale=1920:1080,format=yuv420p[bg]; \
                [bg][v1]overlay=0:0[b1]; \
                [b1][v2]overlay=960:0[b2]; \
                [b2][v3]overlay=0:540[b3]; \
                [b3][v4]overlay=640:540[b4]; \
                [b4][v5]overlay=1280:540[base]; \
                [base]drawtext=text='${BOTTOM_TEXT}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=60:x=w-150*t:y=h-80:box=1:boxcolor=black@0.6:boxborderw=10,format=yuv420p[out]"

        # ุจุฏุก ุงูุจุซ ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ
        echo "๐ ุจุฏุก ุงูุจุซ ุงููุจุงุดุฑ ุญุชู $(date -d @${{ steps.timing.outputs.end_time }})"
        
        while [ $(date +%s) -lt ${{ steps.timing.outputs.end_time }} ]; do
          echo "๐ ุจุฏุก ุฏูุฑุฉ ุจุซ ุฌุฏูุฏุฉ ูู $(date)"
          
          # ุชุญุถูุฑ ูุฏุฎูุงุช ffmpeg
          INPUT1=$(prepare_input "$V1")
          INPUT2=$(prepare_input "$V2")
          INPUT3=$(prepare_input "$V3")
          INPUT4=$(prepare_input "$V4")
          INPUT5=$(prepare_input "$V5")
          
          # ุชูููุฐ ffmpeg ูุน ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
          eval ffmpeg -re -stream_loop -1 -i background.png \
            $INPUT1 $INPUT2 $INPUT3 $INPUT4 $INPUT5 \
            -filter_complex "$FILTER" -map "[out]" -map 1:a? \
            -c:v libx264 -preset ultrafast -tune zerolatency -b:v 2500k -maxrate 2500k -bufsize 5000k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -ar 44100 \
            -f flv "rtmp://a.rtmp.youtube.com/live2?key=$STREAM_KEY" 2>ffmpeg_error.log || {
            
            # ุงูุชุญูู ูู ููุน ุงูุฎุทุฃ
            if grep -q "Invalid argument" ffmpeg_error.log; then
              echo "โ๏ธ ุชุญุฐูุฑ ุจุณูุท ูู ุงูููุชุฑ - ูุชู ุชุฌุงููู"
            else
              echo "โ ุฎุทุฃ ุฌุฏู ูู ุงูุจุซ:"
              cat ffmpeg_error.log
            fi
          }
          
          echo "๐ ุฏูุฑุฉ ุงูุจุซ ุงูุชูุชุ ุงูุชุธุงุฑ 5 ุซูุงูู ูุจู ุฅุนุงุฏุฉ ุงููุญุงููุฉ..."
          sleep 5
          
          # ุฅุนุงุฏุฉ ุงุณุชุฎุฑุงุฌ ุงูุฑูุงุจุท ุงููุงุดูุฉ ููุท
          [[ "$V1" == "background2026.png" ]] && V1=$(extract_url "$URL1")
          [[ "$V2" == "background2026.png" ]] && V2=$(extract_url "$URL2")
          [[ "$V3" == "background2026.png" ]] && V3=$(extract_url "$URL3")
          [[ "$V4" == "background2026.png" ]] && V4=$(extract_url "$URL4")
          [[ "$V5" == "background2026.png" ]] && V5=$(extract_url "$URL5")
        done
        
        echo "โ ุงูุชูู ููุช ุงูุจุซ ุงูููุฑุฑ"
