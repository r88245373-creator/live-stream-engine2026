name: ๐ก IRAN NOW - Ultimate Manual Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'ุฑุงุจุท ููุฏูู 1 ูู Google Drive', required: true }
      url2: { description: 'ุฑุงุจุท ููุฏูู 2 ูู Google Drive', required: true }
      url3: { description: 'ุฑุงุจุท ููุฏูู 3 ูู Google Drive', required: true }
      url4: { description: 'ุฑุงุจุท ููุฏูู 4 ูู Google Drive', required: true }
      url5: { description: 'ุฑุงุจุท ููุฏูู 5 ูู Google Drive', required: true }
      bottom_text: { description: 'ูุต ุงูุดุฑูุท', required: false, default: 'ุจุซ ูุจุงุดุฑ 24/7' }
      stream_duration: { description: 'ุงููุฏุฉ ุจุงูุณุงุนุงุช', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}
  STREAM_URL: "rtmps://a.rtmp.youtube.com:443/live2"

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ุชุซุจูุช ุงููุชุทูุจุงุช ุงููุงููุฉ
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip
        pip3 install --upgrade pip
        pip3 install gdown

    - name: ุชุฌููุฒ ุงูุฎูููุฉ ูุงูุชูููุช
      id: timing
      run: |
        # ุชุญููู ุงูุฎูููุฉ ุงูุฑุฆูุณูุฉ
        gdown --id 1mcqB-MvngWziGqNPuRs9gO39XtdbddgJ -O background.png || ffmpeg -f lavfi -i color=c=black:s=1920x1080 -frames:v 1 background.png
        
        # ุฅูุดุงุก ููุฏูู ุงุญุชูุงุทู
        ffmpeg -f lavfi -i testsrc=size=640x480:rate=30:duration=30 \
               -f lavfi -i sine=frequency=1000:duration=30 \
               -c:v libx264 -c:a aac -t 30 placeholder.mp4
        
        # ุญุณุงุจ ููุช ุงูููุงูุฉ
        END_TIME=$(($(date +%s) + (${{ github.event.inputs.stream_duration }} * 3600)))
        echo "END_TIME=$END_TIME" >> $GITHUB_ENV

    - name: ุชุญููู ุงูููุฏูููุงุช ูู Google Drive
      run: |
        # ุฏุงูุฉ ูุงุณุชุฎุฑุงุฌ File ID ูู ุฑุงุจุท Google Drive
        extract_file_id() {
          local url="$1"
          if [[ $url =~ /d/([a-zA-Z0-9_-]+) ]]; then
            echo "${BASH_REMATCH[1]}"
          elif [[ $url =~ id=([a-zA-Z0-9_-]+) ]]; then
            echo "${BASH_REMATCH[1]}"
          else
            echo ""
          fi
        }

        # ุชุญููู ุฌููุน ุงูููุฏูููุงุช
        mkdir -p videos
        
        for i in {1..5}; do
          url_var="url$i"
          url="${!url_var}"
          file_id=$(extract_file_id "$url")
          
          echo "๐ ุชุญููู video$i ูู: $url"
          
          if [[ -n "$file_id" ]]; then
            if gdown --id "$file_id" -O "videos/video$i.mp4"; then
              echo "โ ุชู ุชุญููู video$i.mp4"
              
              # ุงูุชุญูู ูู ุญุฌู ุงูููู
              filesize=$(stat -c%s "videos/video$i.mp4")
              if [[ $filesize -lt 100000 ]]; then
                echo "โ๏ธ ุงูููู ุตุบูุฑ ุฌุฏุงูุ ุงุณุชุฎุฏุงู ุงูููุฏูู ุงูุงุญุชูุงุทู"
                cp placeholder.mp4 "videos/video$i.mp4"
              fi
            else
              echo "โ๏ธ ูุดู ุงูุชุญูููุ ุงุณุชุฎุฏุงู ุงูููุฏูู ุงูุงุญุชูุงุทู"
              cp placeholder.mp4 "videos/video$i.mp4"
            fi
          else
            echo "โ๏ธ ุฑุงุจุท ุบูุฑ ุตุงูุญ"
            cp placeholder.mp4 "videos/video$i.mp4"
          fi
        done

    - name: ุฅูุดุงุก ููุฏูู ูุฑูุจ
      run: |
        # ุฅูุดุงุก ููุฏูู ูุงุญุฏ ูุญุชูู ุนูู ุฌููุน ุงูุดุงุดุงุช
        echo "๐ฌ ุฅูุดุงุก ููุฏูู ูุฑูุจ ูู 5 ุดุงุดุงุช..."
        
        # ูุต ุงูุดุฑูุท ุงููุชุญุฑู
        BOTTOM_TEXT="${{ github.event.inputs.bottom_text }}"
        
        # ููุชุฑ ุฏูุฌ ุงูุดุงุดุงุช
        FILTER="[0:v]scale=1920:1080[bg]; \
                [1:v]scale=960:540[topL]; \
                [2:v]scale=960:540[topR]; \
                [3:v]scale=640:540[bottomL]; \
                [4:v]scale=640:540[bottomM]; \
                [5:v]scale=640:540[bottomR]; \
                [bg][topL]overlay=0:0[bg1]; \
                [bg1][topR]overlay=960:0[bg2]; \
                [bg2][bottomL]overlay=0:540[bg3]; \
                [bg3][bottomM]overlay=640:540[bg4]; \
                [bg4][bottomR]overlay=1280:540[base]; \
                [base]drawtext=text='${BOTTOM_TEXT}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=60:x=w-150*t:y=h-80:box=1:boxcolor=black@0.6:boxborderw=10[out]"
        
        # ุฅูุดุงุก ููุฏูู ูุงุญุฏ ููุฏุฉ 30 ุซุงููุฉ (ุฃู ุฃุทูู ูุฏุฉ ููุฏูู)
        ffmpeg -i background.png \
               -i videos/video1.mp4 \
               -i videos/video2.mp4 \
               -i videos/video3.mp4 \
               -i videos/video4.mp4 \
               -i videos/video5.mp4 \
               -filter_complex "$FILTER" -map "[out]" -map 1:a? \
               -c:v libx264 -preset medium -b:v 2500k \
               -c:a aac -b:a 128k -ar 44100 \
               -t 30 -y combined.mp4
        
        echo "โ ุชู ุฅูุดุงุก ุงูููุฏูู ุงููุฑูุจ"

    - name: ุจุฏุก ุงูุจุซ ุงููุจุงุดุฑ
      run: |
        END_TIME="${{ env.END_TIME }}"
        
        echo "๐ ุจุฏุก ุงูุจุซ ุงููุจุงุดุฑ ุญุชู $(date -d @$END_TIME)"
        echo "๐ ุนููุงู ุงูุจุซ: ${{ env.STREAM_URL }}/${{ secrets.STREAM_KEY }}"
        
        while [ $(date +%s) -lt $END_TIME ]; do
          REMAINING=$(( END_TIME - $(date +%s) ))
          
          echo "๐ ุฏูุฑุฉ ุจุซ ุฌุฏูุฏุฉ - ุงูููุช ุงููุชุจูู: $REMAINING ุซุงููุฉ"
          
          # ุงูุจุซ ุจุงุณุชุฎุฏุงู ููุณ ุทุฑููุฉ ุงูู YML ุงููุงุฌุญ
          ffmpeg -hide_banner -loglevel warning -re -stream_loop -1 \
            -i combined.mp4 \
            -c:v libx264 -preset ultrafast -tune zerolatency \
            -b:v 2500k -maxrate 2500k -bufsize 5000k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -ar 44100 \
            -f flv -t $REMAINING \
            "${{ env.STREAM_URL }}/${{ secrets.STREAM_KEY }}" || \
            (echo "โ๏ธ Connection lost. Retrying in 5s..." && sleep 5)
        done
        
        echo "โ ุงูุชูู ููุช ุงูุจุซ ุงูููุฑุฑ"
