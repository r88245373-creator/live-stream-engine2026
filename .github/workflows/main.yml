name: ğŸ“¡ IRAN NOW - Ultimate Manual Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 1', required: true }
      url2: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 2', required: true }
      url3: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 3', required: true }
      url4: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 4', required: true }
      url5: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 5', required: true }
      bottom_text: { description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ·', required: false, default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± 24/7' }
      stream_duration: { description: 'Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ø¯Ø¹Ù… impersonation
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip python3-venv
        
        # ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©
        sudo apt-get install -y \
          curl \
          wget \
          libcurl4-openssl-dev \
          libssl-dev \
          python3-dev \
          build-essential \
          pkg-config \
          libffi-dev \
          libxml2-dev \
          libxslt1-dev
        
        # ØªØ­Ø¯ÙŠØ« pip ÙˆØªØ«Ø¨ÙŠØª curl-cffi Ø£ÙˆÙ„Ø§Ù‹
        pip3 install --upgrade pip
        pip3 install --upgrade setuptools wheel
        
        # ØªØ«Ø¨ÙŠØª curl-cffi Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        pip3 install --upgrade curl-cffi
        
        # ØªØ«Ø¨ÙŠØª yt-dlp Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª
        pip3 install --upgrade "yt-dlp[default,curl-cffi,impersonate]" brotli certifi gdown streamlink
        
        # Ø¹Ø±Ø¶ Ø¥ØµØ¯Ø§Ø± yt-dlp ÙˆØ£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©
        echo "âœ… yt-dlp version: $(yt-dlp --version)"
        echo "âœ… Available impersonation targets:"
        yt-dlp --list-impersonate-targets || echo "âš ï¸ Impersonation targets not available yet"

    - name: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª
      id: timing
      run: |
        gdown --id 1mcqB-MvngWziGqNPuRs9gO39XtdbddgJ -O background.png || ffmpeg -f lavfi -i color=c=black:s=1920x1080 -frames:v 1 background.png
        echo "end_time=$(($(date +%s) + (${{ github.event.inputs.stream_duration }} * 3600)))" >> $GITHUB_OUTPUT

    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      run: |
        # Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©
        extract_url() {
          local url="$1"
          local output=""
          
          echo "ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬: $url" >&2
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          if [[ "$url" == *"gledaitv.live"* ]] || [[ "$url" == *"max-sport"* ]] || [[ "$url" == *"live"* ]]; then
            echo "ğŸ“º Ù…ÙˆÙ‚Ø¹ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± ØªÙ„ÙØ²ÙŠÙˆÙ†ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… streamlink..." >&2
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ streamlink Ø£ÙˆÙ„Ø§Ù‹ (Ø£ÙØ¶Ù„ Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªÙ„ÙØ²ÙŠÙˆÙ†ÙŠØ©)
            if command -v streamlink &> /dev/null; then
              # ØªØ¬Ø±Ø¨Ø© Ø¹Ø¯Ø© Ø¬ÙˆØ¯Ø§Øª
              for quality in "best" "1080p" "720p" "480p" "worst"; do
                streamlink --stdout --url "$url" "$quality" 2>/dev/null | head -c 1000000 2>/dev/null && {
                  echo "âœ… streamlink Ù†Ø¬Ø­ Ù…Ø¹ Ø§Ù„Ø¬ÙˆØ¯Ø©: $quality" >&2
                  echo "streamlink://$url/$quality"
                  return 0
                }
              done
            fi
          fi
          
          # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: impersonate chrome Ù…Ø¹ curl-cffi
          output=$(yt-dlp --quiet --no-warnings --get-url \
            --impersonate chrome:windows-10 \
            --extractor-args "dailymotion:impersonate=firefox" \
            "$url" 2>/dev/null) && {
            echo "âœ… Ù†Ø¬Ø­ Ù…Ø¹ chrome impersonation" >&2
            echo "$output"
            return 0
          }
          
          # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: impersonate firefox
          output=$(yt-dlp --quiet --no-warnings --get-url \
            --impersonate firefox:windows-10 \
            "$url" 2>/dev/null) && {
            echo "âœ… Ù†Ø¬Ø­ Ù…Ø¹ firefox impersonation" >&2
            echo "$output"
            return 0
          }
          
          # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 3: impersonate safari
          output=$(yt-dlp --quiet --no-warnings --get-url \
            --impersonate safari:macos-11 \
            "$url" 2>/dev/null) && {
            echo "âœ… Ù†Ø¬Ø­ Ù…Ø¹ safari impersonation" >&2
            echo "$output"
            return 0
          }
          
          # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 4: Ø¨Ø¯ÙˆÙ† impersonation Ù…Ø¹ headers Ù…Ø®ØµØµØ©
          output=$(yt-dlp --quiet --no-warnings --get-url \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            --add-header "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
            --add-header "Accept-Language: en-US,en;q=0.5" \
            --add-header "Referer: https://www.dailymotion.com/" \
            --add-header "DNT: 1" \
            "$url" 2>/dev/null) && {
            echo "âœ… Ù†Ø¬Ø­ Ù…Ø¹ headers Ù…Ø®ØµØµØ©" >&2
            echo "$output"
            return 0
          }
          
          # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 5: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† m3u8 Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
          echo "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† m3u8 Ù…Ø¨Ø§Ø´Ø±Ø©..." >&2
          m3u8_url=$(curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "$url" | grep -o 'https://[^"]*\.m3u8[^"]*' | head -1)
          
          if [[ -n "$m3u8_url" ]]; then
            echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ m3u8 Ù…Ø¨Ø§Ø´Ø±: $m3u8_url" >&2
            echo "$m3u8_url"
            return 0
          fi
          
          # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 6: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ ÙƒØ­Ù„ Ø£Ø®ÙŠØ±
          echo "âš ï¸ ÙØ´Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§ØªØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ" >&2
          echo "$url"
        }

        # Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
        validate_url() {
          local url="$1"
          local name="$2"
          
          if [[ "$url" == *"gledaitv.live"* ]] || [[ "$url" == *"max-sport"* ]]; then
            echo "ğŸ“º Ø±Ø§Ø¨Ø· $name: Ù…ÙˆÙ‚Ø¹ ØªÙ„ÙØ²ÙŠÙˆÙ†ÙŠ Ù…Ø¨Ø§Ø´Ø± - Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ø¨Ø´ÙƒÙ„ Ø®Ø§Øµ"
            return 0
          elif [[ "$url" =~ ^https?:// ]]; then
            return 0
          else
            echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø±Ø§Ø¨Ø· $name Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† ØµØ§Ù„Ø­Ø§Ù‹: $url"
            return 1
          fi
        }

        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        echo "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ..."
        
        URL1="${{ github.event.inputs.url1 }}"
        URL2="${{ github.event.inputs.url2 }}"
        URL3="${{ github.event.inputs.url3 }}"
        URL4="${{ github.event.inputs.url4 }}"
        URL5="${{ github.event.inputs.url5 }}"
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙØ¹Ù„ÙŠØ©
        V1=$(extract_url "$URL1")
        V2=$(extract_url "$URL2")
        V3=$(extract_url "$URL3")
        V4=$(extract_url "$URL4")
        V5=$(extract_url "$URL5")
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        echo "âœ… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬:"
        echo "V1: $V1"
        echo "V2: $V2"
        echo "V3: $V3"
        echo "V4: $V4"
        echo "V5: $V5"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        validate_url "$V1" "1" || V1="$URL1"
        validate_url "$V2" "2" || V2="$URL2"
        validate_url "$V3" "3" || V3="$URL3"
        validate_url "$V4" "4" || V4="$URL4"
        validate_url "$V5" "5" || V5="$URL5"

        # ÙÙ„ØªØ± Ø¯Ù…Ø¬ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙÙŠØ©
        FILTER="[1:v]scale=960:540,setsar=1[v1]; [2:v]scale=960:540,setsar=1[v2]; \
                [3:v]scale=640:540,setsar=1[v3]; [4:v]scale=640:540,setsar=1[v4]; \
                [5:v]scale=640:540,setsar=1[v5]; [0:v]scale=1920:1080[bg]; \
                [bg][v1]overlay=0:0[b1]; [b1][v2]overlay=960:0[b2]; \
                [b2][v3]overlay=0:540[b3]; [b3][v4]overlay=640:540[b4]; \
                [b4][v5]overlay=1280:540[b5]; \
                [b5]drawtext=text='${{ github.event.inputs.bottom_text }}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=60:x=w-mod(150*t\,w+tw):y=h-80:box=1:boxcolor=black@0.6[out]"

        # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        echo "ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø­ØªÙ‰ $(date -d @${{ steps.timing.outputs.end_time }})"
        
        while [ $(date +%s) -lt ${{ steps.timing.outputs.end_time }} ]; do
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ $(date)"
          
          # ØªØ¬Ù‡ÙŠØ² Ù…Ø¯Ø®Ù„Ø§Øª ffmpeg Ø¨Ø´ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
          FFMPEG_CMD="ffmpeg -re -stream_loop -1 -i background.png"
          
          # Ø¥Ø¶Ø§ÙØ© ÙƒÙ„ Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø©
          for i in 1 2 3 4 5; do
            url_var="V$i"
            url="${!url_var}"
            
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† streamlinkØŒ Ø§Ø³ØªØ®Ø¯Ù… ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ
            if [[ "$url" == streamlink://* ]]; then
              # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù† streamlink
              stream_url=$(echo "$url" | sed 's/streamlink:\/\///' | cut -d'/' -f1)
              quality=$(echo "$url" | cut -d'/' -f2)
              FFMPEG_CMD="$FFMPEG_CMD -i <(streamlink --stdout --url '$stream_url' '$quality')"
            else
              # Ø±Ø§Ø¨Ø· Ø¹Ø§Ø¯ÙŠ Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
              FFMPEG_CMD="$FFMPEG_CMD -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 -timeout 30000000 -rw_timeout 30000000 -i '$url'"
            fi
          done
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø´Ø­Ø§Øª Ø§Ù„ØªØ±Ù…ÙŠØ² ÙˆØ§Ù„Ø¨Ø«
          FFMPEG_CMD="$FFMPEG_CMD -filter_complex \"$FILTER\" -map \"[out]\" -map 1:a -c:v libx264 -preset ultrafast -tune zerolatency -b:v 2500k -maxrate 2500k -bufsize 5000k -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -ar 44100 -f flv \"rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY\""
          
          # ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±
          eval $FFMPEG_CMD
          
          # Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø« Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ØŒ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
          echo "âš ï¸ ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø«ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ..."
          sleep 10
          
          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¥Ø°Ø§ ÙØ´Ù„Øª (Ø¨Ø¹Ø¶ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù‚Ø¯ ØªÙ†ØªÙ‡ÙŠ ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§)
          echo "ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·..."
          V1=$(extract_url "$URL1")
          V2=$(extract_url "$URL2")
          V3=$(extract_url "$URL3")
          V4=$(extract_url "$URL4")
          V5=$(extract_url "$URL5")
        done
        
        echo "âœ… Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ù‚Ø±Ø±"
