name: ğŸ“¡ IRAN NOW - Manual Input Live Stream
on:
  workflow_dispatch:
    inputs:
      url1:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØµÙˆØª)'
        required: true
      url2:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø«Ø§Ù†ÙŠ'
        required: true
      url3:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø«Ø§Ù„Ø«'
        required: true
      url4:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø±Ø§Ø¨Ø¹'
        required: true
      url5:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§Ù…Ø³'
        required: true
      bottom_text:
        description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØ­Ø±Ùƒ'
        required: false
        default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± 24/7'
      stream_duration:
        description: 'Ù…Ø¯Ø© Ø§Ù„Ø¨Ø« Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª'
        required: false
        default: '5'

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}

jobs:
  stream:
    name: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      uses: actions/checkout@v4

    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª (FFmpeg & yt-dlp & gdown)
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core bc python3-pip
        sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
        sudo chmod a+rx /usr/local/bin/yt-dlp
        pip3 install gdown

    - name: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆÙ‚ÙŠØª
      id: timing
      run: |
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ Ù‚Ø¯Ù…ØªÙ‡
        gdown --id 1mcqB-MvngWziGqNPuRs9gO39XtdbddgJ -O background.png
        
        # ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        if [ ! -f "background.png" ]; then
          ffmpeg -f lavfi -i color=c=black:s=1920x1080 -frames:v 1 background.png
        fi
        
        START_TIME=$(date +%s)
        DURATION=${{ github.event.inputs.stream_duration || 5 }}
        END_TIME=$(($START_TIME + ($DURATION * 3600)))
        echo "end_time=$END_TIME" >> $GITHUB_OUTPUT

    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      run: |
        echo "ğŸš€ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«..."
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… yt-dlp Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø±ÙˆØ§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨
        V1=$(yt-dlp -g "${{ github.event.inputs.url1 }}" || echo "${{ github.event.inputs.url1 }}")
        V2=$(yt-dlp -g "${{ github.event.inputs.url2 }}" || echo "${{ github.event.inputs.url2 }}")
        V3=$(yt-dlp -g "${{ github.event.inputs.url3 }}" || echo "${{ github.event.inputs.url3 }}")
        V4=$(yt-dlp -g "${{ github.event.inputs.url4 }}" || echo "${{ github.event.inputs.url4 }}")
        V5=$(yt-dlp -g "${{ github.event.inputs.url5 }}" || echo "${{ github.event.inputs.url5 }}")

        FILTER="[1:v]scale=960:540,setsar=1[v1]; \
                [2:v]scale=960:540,setsar=1[v2]; \
                [3:v]scale=640:540,setsar=1[v3]; \
                [4:v]scale=640:540,setsar=1[v4]; \
                [5:v]scale=640:540,setsar=1[v5]; \
                [0:v][v1]overlay=0:0[b1]; \
                [b1][v2]overlay=960:0[b2]; \
                [b2][v3]overlay=0:540[b3]; \
                [b3][v4]overlay=640:540[b4]; \
                [b4][v5]overlay=1280:540[b5]; \
                [b5]drawtext=text='${{ github.event.inputs.bottom_text }}':\
                fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=60:\
                x=w-mod(150*t\,w+tw):y=h-80:box=1:boxcolor=black@0.6[out]"

        while [ $(date +%s) -lt ${{ steps.timing.outputs.end_time }} ]; do
          ffmpeg -re -stream_loop -1 -i background.png \
            -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -i "$V1" -i "$V2" -i "$V3" -i "$V4" -i "$V5" \
            -filter_complex "$FILTER" -map "[out]" -map 1:a \
            -c:v libx264 -preset ultrafast -tune zerolatency -b:v 2500k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -ar 44100 \
            -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY" || echo "âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§ØªØµØ§Ù„..."
          sleep 5
        done
