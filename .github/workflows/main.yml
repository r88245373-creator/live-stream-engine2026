name: ğŸ“¡ IRAN NOW - Ultimate Manual Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 1 Ù…Ù† Google Drive', required: true }
      url2: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 2 Ù…Ù† Google Drive', required: true }
      url3: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 3 Ù…Ù† Google Drive', required: true }
      url4: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 4 Ù…Ù† Google Drive', required: true }
      url5: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 5 Ù…Ù† Google Drive', required: true }
      bottom_text: { description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ·', required: false, default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± 24/7' }
      stream_duration: { description: 'Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}
  STREAM_URL: "rtmps://a.rtmp.youtube.com:443/live2"
  URL1: ${{ github.event.inputs.url1 }}
  URL2: ${{ github.event.inputs.url2 }}
  URL3: ${{ github.event.inputs.url3 }}
  URL4: ${{ github.event.inputs.url4 }}
  URL5: ${{ github.event.inputs.url5 }}
  BOTTOM_TEXT: ${{ github.event.inputs.bottom_text }}
  STREAM_DURATION: ${{ github.event.inputs.stream_duration }}

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip
        pip3 install --upgrade pip
        pip3 install gdown

    - name: Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
      run: |
        echo "ğŸ“Œ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:"
        echo "URL1: ${{ env.URL1 }}"
        echo "URL2: ${{ env.URL2 }}"
        echo "URL3: ${{ env.URL3 }}"
        echo "URL4: ${{ env.URL4 }}"
        echo "URL5: ${{ env.URL5 }}"

    - name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Stream Key
      run: |
        if [ -z "${{ secrets.YOUTUBE_STREAM_KEY }}" ]; then
          echo "âŒ ERROR: YOUTUBE_STREAM_KEY is not set in GitHub Secrets!"
          exit 1
        else
          echo "âœ… YOUTUBE_STREAM_KEY is set (length: ${#STREAM_KEY})"
        fi

    - name: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª
      id: timing
      run: |
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ background2026.png
        if [[ ! -f "background2026.png" ]]; then
          echo "âš ï¸ background2026.png ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡"
          ffmpeg -f lavfi -i color=c=black:s=3840x2160 -frames:v 1 background2026.png
        else
          echo "âœ… background2026.png Ù…ÙˆØ¬ÙˆØ¯"
          # ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¥Ù„Ù‰ 3840x2160 Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ÙƒØ°Ù„Ùƒ
          ffmpeg -i background2026.png -vf "scale=3840:2160:force_original_aspect_ratio=1,pad=3840:2160:(ow-iw)/2:(oh-ih)/2" -y background_fixed.png
          mv background_fixed.png background2026.png
        fi
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        ffmpeg -f lavfi -i testsrc=size=640x480:rate=30:duration=30 \
               -f lavfi -i sine=frequency=1000:duration=30 \
               -c:v libx264 -c:a aac -t 30 placeholder.mp4
        
        # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        END_TIME=$(($(date +%s) + (${{ env.STREAM_DURATION }} * 3600)))
        echo "END_TIME=$END_TIME" >> $GITHUB_ENV

    - name: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Google Drive
      run: |
        extract_file_id() {
          local url="$1"
          if [[ $url =~ /d/([a-zA-Z0-9_-]+) ]]; then
            echo "${BASH_REMATCH[1]}"
          elif [[ $url =~ id=([a-zA-Z0-9_-]+) ]]; then
            echo "${BASH_REMATCH[1]}"
          else
            echo ""
          fi
        }

        mkdir -p videos
        urls=("${{ env.URL1 }}" "${{ env.URL2 }}" "${{ env.URL3 }}" "${{ env.URL4 }}" "${{ env.URL5 }}")
        
        for i in {0..4}; do
          url="${urls[$i]}"
          video_num=$((i+1))
          
          echo "ğŸ”„ ØªØ­Ù…ÙŠÙ„ video$video_num Ù…Ù†: $url"
          
          if [[ -z "$url" || "$url" == "null" ]]; then
            cp placeholder.mp4 "videos/video$video_num.mp4"
            continue
          fi
          
          file_id=$(extract_file_id "$url")
          
          if [[ -n "$file_id" ]]; then
            if gdown --id "$file_id" -O "videos/video$video_num.mp4"; then
              echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ video$video_num.mp4"
              filesize=$(stat -c%s "videos/video$video_num.mp4")
              if [[ $filesize -lt 100000 ]]; then
                cp placeholder.mp4 "videos/video$video_num.mp4"
              fi
            else
              cp placeholder.mp4 "videos/video$video_num.mp4"
            fi
          else
            cp placeholder.mp4 "videos/video$video_num.mp4"
          fi
        done

    - name: Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ù…Ø±ÙƒØ¨ Ø¨Ø¯Ù‚Ø© 1920x1080
      run: |
        echo "ğŸ¬ Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ù…Ø±ÙƒØ¨ Ù…Ù† 5 Ø´Ø§Ø´Ø§Øª Ø¨Ø¯Ù‚Ø© 1920x1080..."
        
        BOTTOM_TEXT="${{ env.BOTTOM_TEXT }}"
        
        # ÙÙ„ØªØ± Ø¯Ù…Ø¬ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…Ø¹ Ø¶Ø¨Ø· Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        FILTER="[1:v]scale=960:540[green]; \
                [2:v]scale=960:540[red]; \
                [3:v]scale=640:540[yellow]; \
                [4:v]scale=640:540[blue]; \
                [5:v]scale=640:540[grey]; \
                [0:v]scale=1920:1080[bg]; \
                [bg][green]overlay=0:0[b1]; \
                [b1][red]overlay=960:0[b2]; \
                [b2][yellow]overlay=0:540[b3]; \
                [b3][blue]overlay=640:540[b4]; \
                [b4][grey]overlay=1280:540[b5]; \
                [b5]drawtext=text='${BOTTOM_TEXT}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=60:x=w-150*t:y=h-80:box=1:boxcolor=black@0.6:boxborderw=10[out]"
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø­Ø¯
        ffmpeg -i background2026.png \
               -i videos/video1.mp4 \
               -i videos/video2.mp4 \
               -i videos/video3.mp4 \
               -i videos/video4.mp4 \
               -i videos/video5.mp4 \
               -filter_complex "$FILTER" -map "[out]" -map 1:a? \
               -c:v libx264 -preset fast -b:v 6800k -maxrate 6800k -bufsize 13600k \
               -c:a aac -b:a 192k -ar 44100 \
               -t 30 -y combined.mp4
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø±ÙƒØ¨"
        echo "ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø±ÙƒØ¨:"
        ffprobe -v quiet -select_streams v:0 -show_entries stream=width,height -of default=noprint_wrappers=1 combined.mp4

    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©
      run: |
        END_TIME="${{ env.END_TIME }}"
        STREAM_URL_FULL="${{ env.STREAM_URL }}/${{ secrets.YOUTUBE_STREAM_KEY }}"
        
        echo "ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø­ØªÙ‰ $(date -d @$END_TIME)"
        echo "ğŸš€ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø«: $STREAM_URL_FULL"
        
        while [ $(date +%s) -lt $END_TIME ]; do
          REMAINING=$(( END_TIME - $(date +%s) ))
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Ø¯ÙˆØ±Ø© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø© - $(date)"
          echo "â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: $((REMAINING / 3600))h $(((REMAINING % 3600) / 60))m"
          echo "ğŸ“¡ Ø§Ù„Ø¨Ø« Ø¥Ù„Ù‰: $STREAM_URL_FULL"
          echo "ğŸ¬ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«: 1080p | 6800 Kbps | AAC 192k"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ffmpeg -hide_banner -loglevel warning -re -stream_loop -1 \
            -i combined.mp4 \
            -c:v libx264 -preset veryfast -tune zerolatency \
            -b:v 6800k -maxrate 6800k -bufsize 13600k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 192k -ar 44100 \
            -f flv -t $REMAINING \
            "$STREAM_URL_FULL" || (echo "âš ï¸ Connection lost. Retrying in 5s..." && sleep 5)
        done
        
        echo "âœ… Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ù‚Ø±Ø±"
