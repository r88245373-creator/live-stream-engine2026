name: ğŸ“¡ IRAN NOW - Ultimate Pro Stream
on:
  workflow_dispatch:
    inputs:
      url1: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 1 (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø®Ø¶Ø±)', required: true }
      url2: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 2 (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø­Ù…Ø±)', required: true }
      url3: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 3 (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£ØµÙØ±)', required: true }
      url4: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 4 (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø²Ø±Ù‚)', required: true }
      url5: { description: 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ 5 (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ)', required: true }
      bottom_text: { description: 'Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØ­Ø±Ùƒ', required: false, default: 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø¥ÙŠØ±Ø§Ù† 24/7' }
      stream_duration: { description: 'Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª (Ø§Ù„Ø£Ù‚ØµÙ‰ 6)', required: false, default: '5' }

env:
  STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}
  STREAM_URL: "rtmps://a.rtmp.youtube.com:443/live2"

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core python3-pip
        pip3 install gdown

    - name: Download Videos from Google Drive
      run: |
        extract_file_id() {
          local url="$1"
          if [[ $url =~ /d/([a-zA-Z0-9_-]+) ]]; then echo "${BASH_REMATCH[1]}"
          elif [[ $url =~ id=([a-zA-Z0-9_-]+) ]]; then echo "${BASH_REMATCH[1]}"
          else echo ""; fi
        }

        mkdir -p videos
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø®Ù…Ø³Ø©
        for i in {1..5}; do
          url_var="url$i"
          url="${{ github.event.inputs.$url_var }}"
          file_id=$(extract_file_id "$url")
          echo "ğŸ”„ Downloading Video $i..."
          if [[ -n "$file_id" ]]; then
            gdown --id "$file_id" -O "videos/video$i.mp4" || touch "videos/video$i.mp4"
          fi
        done

    - name: Start Live Stream (Real-time Processing)
      run: |
        # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
        DURATION_SEC=$(( ${{ github.event.inputs.stream_duration }} * 3600 ))
        STREAM_URL_FULL="${{ env.STREAM_URL }}/${{ secrets.YOUTUBE_STREAM_KEY }}"
        BOTTOM_TEXT="${{ github.event.inputs.bottom_text }}"

        echo "ğŸš€ Starting Stream for $DURATION_SEC seconds..."

        # ÙÙ„ØªØ± Complex: 
        # 1. ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© (force_original_aspect_ratio)
        # 2. Ø¥Ø¶Ø§ÙØ© Ø­ÙˆØ§Ù Ø³ÙˆØ¯Ø§Ø¡ (pad) Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙØ±Ø§ØºØ§Øª ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø©
        # 3. ÙˆØ¶Ø¹ ÙƒÙ„ ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§ØªÙ‡ Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø®Ø·Ø· Ø§Ù„ØµÙˆØ±Ø©
        
        ffmpeg -re -stream_loop -1 -i "pro dashboard v2.0.png" \
               -re -stream_loop -1 -i "videos/video1.mp4" \
               -re -stream_loop -1 -i "videos/video2.mp4" \
               -re -stream_loop -1 -i "videos/video3.mp4" \
               -re -stream_loop -1 -i "videos/video4.mp4" \
               -re -stream_loop -1 -i "videos/video5.mp4" \
               -filter_complex " \
                [1:v]scale=1920:1000:force_original_aspect_ratio=decrease,pad=1920:1000:(ow-iw)/2:(oh-ih)/2[green]; \
                [2:v]scale=1920:1000:force_original_aspect_ratio=decrease,pad=1920:1000:(ow-iw)/2:(oh-ih)/2[red]; \
                [3:v]scale=1520:940:force_original_aspect_ratio=decrease,pad=1520:940:(ow-iw)/2:(oh-ih)/2[yellow]; \
                [4:v]scale=1540:940:force_original_aspect_ratio=decrease,pad=1540:940:(ow-iw)/2:(oh-ih)/2[blue]; \
                [5:v]scale=780:940:force_original_aspect_ratio=decrease,pad=780:940:(ow-iw)/2:(oh-ih)/2[grey]; \
                [0:v][green]overlay=x=0:y=0[b1]; \
                [b1][red]overlay=x=1920:y=0[b2]; \
                [b2][yellow]overlay=x=0:y=1000[b3]; \
                [b3][blue]overlay=x=1520:y=1000[b4]; \
                [b4][grey]overlay=x=3060:y=1000[b5]; \
                [b5]drawtext=text='${BOTTOM_TEXT}':fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:fontcolor=white:fontsize=80:shadowcolor=black:shadowx=4:shadowy=4:y=h-120:x=w-mod(t*150\,w+tw)[out]" \
               -map "[out]" \
               -map 1:a? \
               -c:v libx264 -preset ultrafast -tune zerolatency -b:v 4000k -maxrate 4000k -bufsize 8000k \
               -pix_fmt yuv420p -g 60 \
               -c:a aac -b:a 128k -ar 44100 \
               -f flv -t $DURATION_SEC \
               "$STREAM_URL_FULL"
